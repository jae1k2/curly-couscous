<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Seoul Shared Eats</title>

  <!-- Kakao Maps -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=5c2fb05e6765f133c747e1f5a2bdf64d
&libraries=services"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --text:#eef1f8;
      --muted:rgba(238,241,248,.65);

      --glass:rgba(18,20,28,.74);
      --glass2:rgba(18,20,28,.86);
      --line:rgba(255,255,255,.12);

      --shadow:0 18px 52px rgba(0,0,0,.38);

      --accent:#6aa6ff;
      --hot:#ff4d6d;
      --mid:#a06bff;
      --low:#8aa0bd;

      --pill:999px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;color:var(--text)}
    #map{position:fixed;inset:0}

    /* Bottom place bar (always visible) */
    .placebar{
      position:fixed;
      left:50%; transform:translateX(-50%);
      bottom:76px; /* sits above dock */
      width:min(640px, calc(100vw - 24px));
      display:flex; align-items:stretch; gap:10px;
      padding:10px 12px;
      background:var(--glass);
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      backdrop-filter:blur(16px);
      z-index:1100;
    }
    .navBtn{
      width:44px; min-width:44px;
      border-radius:18px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.12);
      color:var(--text);
      cursor:pointer;
      user-select:none;
      display:flex; align-items:center; justify-content:center;
      font-size:16px;
    }
    .navBtn:disabled{opacity:.5; cursor:not-allowed}
    .pbMain{
      flex:1; min-width:0;
      display:flex; flex-direction:column; gap:6px;
      padding:2px 2px;
    }
    .pbTitle{
      font-weight:950; font-size:13.5px; line-height:1.2;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .pbAddr{
      color:var(--muted); font-size:12px; line-height:1.35;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .pbMeta{
      display:flex; gap:10px; flex-wrap:wrap;
      color:rgba(238,241,248,.55);
      font-size:12px;
      line-height:1.2;
    }
    .pbActions{
      display:flex; gap:8px; align-items:center;
      margin-top:2px;
    }

    /* Dock */
    .dock{
      position:fixed;
      left:50%; transform:translateX(-50%);
      bottom:14px;
      width:min(640px, calc(100vw - 24px));
      display:flex; gap:10px; align-items:center;
      padding:10px 12px;
      background:var(--glass);
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      backdrop-filter:blur(16px);
      z-index:1000;
    }
    .search{
      flex:1;
      display:flex; gap:8px; align-items:center;
      padding:10px 12px;
      border-radius:var(--pill);
      border:1px solid var(--line);
      background:rgba(0,0,0,.10);
      min-width:120px;
    }
    .search input{
      width:100%; border:0; outline:0; background:transparent;
      color:var(--text); font-size:14px;
    }
    .search input::placeholder{color:rgba(238,241,248,.42)}
    button{
      border:1px solid var(--line);
      background:rgba(0,0,0,.12);
      color:var(--text);
      padding:10px 12px;
      border-radius:var(--pill);
      cursor:pointer;
      white-space:nowrap;
      user-select:none;
    }
    button.primary{
      background:rgba(106,166,255,.16);
      border-color:rgba(106,166,255,.45);
    }
    button.danger{
      background:rgba(255,77,109,.12);
      border-color:rgba(255,77,109,.35);
    }
    button:disabled{opacity:.55; cursor:not-allowed}
    .dock .right{display:flex; gap:8px; align-items:center}
    @media (max-width:520px){
      .dock{gap:8px}
      button{padding:10px 10px}
      .placebar{gap:8px}
      .navBtn{width:40px; min-width:40px}
    }

    /* Floating windows */
    .float{
      position:fixed;
      background:var(--glass2);
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      backdrop-filter:blur(18px);
      z-index:1600;
      overflow:hidden;
      pointer-events:auto;
    }
    .floatHeader{
      display:flex; gap:10px; align-items:center;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      user-select:none;
    }
    .floatHeader h3{
      margin:0; font-size:14px; line-height:1.25;
      font-weight:950; flex:1; min-width:0;
    }
    .floatBody{padding:14px; max-height:72vh; overflow:auto}
    .hint{font-size:12px; color:var(--muted); line-height:1.45}
    .sub{margin-top:6px; color:var(--muted); font-size:12px; line-height:1.35; word-break:break-word}

    .cardItem{
      background:rgba(0,0,0,.12);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      margin-bottom:10px;
    }
    .visitTop{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .badge{
      font-size:12px; padding:6px 10px;
      border-radius:var(--pill);
      border:1px solid var(--line);
      background:rgba(0,0,0,.10);
      white-space:nowrap;
    }
    .visitContent{margin-top:10px; white-space:pre-wrap; font-size:13px; line-height:1.55}
    .miniActions{display:flex; gap:8px; margin-top:10px; justify-content:flex-end}
    .miniActions button{padding:8px 10px}

    label{display:block; font-size:12px; color:rgba(238,241,248,.70); margin:0 0 6px}
    input, textarea{
      width:100%;
      border:1px solid var(--line);
      background:rgba(0,0,0,.14);
      color:var(--text);
      border-radius:14px;
      padding:10px;
      outline:none;
      font-size:13px;
    }
    textarea{min-height:180px; resize:vertical; line-height:1.55}
    .grid{display:grid; grid-template-columns:1fr 140px; gap:10px}
    .row{display:flex; gap:8px; justify-content:flex-end; margin-top:10px}

    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.35);
      display:none; align-items:center; justify-content:center;
      padding:16px;
      z-index:2000;
    }
    .overlay.open{display:flex}
    .modal{
      width:min(760px,96vw);
      background:var(--glass2);
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      backdrop-filter:blur(18px);
      overflow:hidden;
      pointer-events:auto;
    }
    .modalHeader{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; gap:10px;
    }
    .modalHeader h3{margin:0; font-size:15px; flex:1; font-weight:950}
    .modalBody{padding:16px}
    .results{margin-top:10px; display:flex; flex-direction:column; gap:8px}
    .resultItem{
      padding:12px;
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(0,0,0,.12);
      cursor:pointer;
      pointer-events:auto;
    }
    .resultItem:hover{border-color:rgba(106,166,255,.55)}
    .resultItem .t{font-weight:950; font-size:13px; margin-bottom:4px}
    .resultItem .s{font-size:12px; color:var(--muted); line-height:1.35}

    .toast{
      position:fixed;
      left:50%; transform:translateX(-50%);
      bottom:146px; /* above placebar + dock */
      background:rgba(18,20,28,.92);
      border:1px solid var(--line);
      border-radius:var(--pill);
      padding:10px 14px;
      box-shadow:var(--shadow);
      display:none; gap:10px; align-items:center;
      z-index:3000;
      backdrop-filter:blur(16px);
    }
    .toast.show{display:flex}
    .dot{width:8px; height:8px; border-radius:50%; background:var(--accent)}

    .dragBar{ cursor:grab; }
    .dragBar:active{ cursor:grabbing; }

    .pinBtn{
      padding:8px 10px;
      border-radius:14px;
      display:inline-flex; gap:8px; align-items:center;
    }
    .pinOn{
      background:rgba(255,255,255,.10);
      border-color:rgba(255,255,255,.22);
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <!-- ALWAYS visible place bar (fixed above the dock) -->
  <div id="placeBar" class="placebar">
    <button id="prevPlaceBtn" class="navBtn" title="ì´ì „">â—€</button>

    <div class="pbMain">
      <div class="pbTitle" id="pbName">ê°€ê²Œ ë¡œë”© ì¤‘â€¦</div>
      <div class="pbAddr" id="pbAddr">ì ì‹œë§Œ</div>
      <div class="pbMeta" id="pbMeta"></div>

      <div class="pbActions">
        <button id="pbVisitsBtn">ê¸°ë¡</button>
        <button id="pbWriteBtn" class="primary">ì‘ì„±</button>
        <button id="pbManageBtn" style="display:none">ê´€ë¦¬</button>
      </div>
    </div>

    <button id="nextPlaceBtn" class="navBtn" title="ëœë¤ ë‹¤ìŒ">â–¶</button>
  </div>

  <div class="dock">
    <div class="search" title="ê°€ê²Œ/ì£¼ì†Œ ê²€ìƒ‰ (Enter)">
      <span style="opacity:.75">ğŸ”</span>
      <input id="q" placeholder="ê²€ìƒ‰ (Enter)" />
    </div>

    <div class="right">
      <button id="addBtn" class="primary">ì¶”ê°€</button>

      <button id="loginOpenBtn">ë¡œê·¸ì¸</button>
      <button id="signupOpenBtn">íšŒì›ê°€ì…</button>

      <button id="accountOpenBtn" style="display:none">ê³„ì •</button>
    </div>
  </div>

  <!-- Visits window -->
  <aside id="visitsWin" class="float" style="display:none; width:min(620px,94vw); right:14px; top:14px;">
    <div class="floatHeader dragBar" id="visitsDragBar">
      <h3 id="visitsTitle">ë°©ë¬¸ ê¸°ë¡</h3>
      <button id="visitsPinBtn" class="pinBtn" title="í•€ ê³ ì •">ğŸ“Œ</button>
      <button id="closeVisitsBtn">ë‹«ê¸°</button>
    </div>
    <div class="floatBody">
      <div class="hint" id="visitsHint">í•˜ë‹¨ ë°”ì—ì„œ â€œê¸°ë¡â€ì„ ëˆ„ë¥´ë©´ ì—´ë ¤.</div>
      <div style="margin-top:12px" id="visits"></div>
    </div>
  </aside>

  <!-- Editor window -->
  <aside id="editorWin" class="float" style="display:none; width:min(760px,94vw); left:14px; top:14px;">
    <div class="floatHeader dragBar" id="editorDragBar">
      <h3 id="editorTitle">ë°©ë¬¸ê¸° ì‘ì„±</h3>
      <button id="editorPinBtn" class="pinBtn" title="í•€ ê³ ì •">ğŸ“Œ</button>
      <button id="closeEditorBtn">ë‹«ê¸°</button>
    </div>
    <div class="floatBody">
      <div class="hint" id="editorHint">í•€ OFFë©´ ë‹¤ë¥¸ ê°€ê²Œ â€œì‘ì„±â€ ë²„íŠ¼ìœ¼ë¡œ ì´ ì°½ì„ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆì–´.</div>

      <div style="margin-top:12px" class="grid">
        <div>
          <label>ë°©ë¬¸ ë‚ ì§œ</label>
          <input id="visitDate" type="date" />
        </div>
        <div>
          <label>í‰ì </label>
          <input id="visitRating" type="number" min="0" max="5" step="0.5" placeholder="4.5" />
        </div>
      </div>

      <div style="margin-top:10px">
        <label>ë°©ë¬¸ê¸°</label>
        <textarea id="visitContent" placeholder="ë¬¸ì„œì²˜ëŸ¼ ì ì–´ë„ ë¨"></textarea>
      </div>

      <div class="row">
        <button id="cancelEditBtn" style="display:none">í¸ì§‘ ì·¨ì†Œ</button>
        <button id="saveVisitBtn" class="primary">ì €ì¥</button>
      </div>

      <div class="hint" style="margin-top:10px">
        ì‘ì„±ì í‘œì‹œëŠ” ë‹‰ë„¤ì„. (ë‹‰ë„¤ì„ ì—†ìœ¼ë©´ ì‘ì„± ë¶ˆê°€)
      </div>
    </div>
  </aside>

  <!-- Place manage window -->
  <aside id="placeWin" class="float" style="display:none; width:min(640px,94vw); left:14px; top:90px;">
    <div class="floatHeader dragBar" id="placeDragBar">
      <h3 id="placeTitle">ê°€ê²Œ ê´€ë¦¬</h3>
      <button id="closePlaceBtn">ë‹«ê¸°</button>
    </div>
    <div class="floatBody">
      <div class="hint" id="placeHint">ê°€ê²Œ ìˆ˜ì •/ì‚­ì œëŠ” â€œì¶”ê°€í•œ ì‚¬ëŒâ€ë§Œ ê°€ëŠ¥.</div>

      <div class="cardItem" style="margin-top:12px">
        <label>ê°€ê²Œ ì´ë¦„</label>
        <input id="editPlaceName" />
        <label style="margin-top:10px">ì£¼ì†Œ</label>
        <input id="editPlaceAddr" />

        <div class="row" style="justify-content:flex-start;margin-top:10px">
          <button id="placeAddrSearchBtn" class="primary">ì£¼ì†Œ í›„ë³´ ë³´ê¸°</button>
          <span id="placeGeoStatus" class="hint"></span>
        </div>
        <div id="placeResults" class="results"></div>

        <div class="row" style="margin-top:12px">
          <button id="savePlaceBtn" class="primary">ìˆ˜ì • ì €ì¥</button>
          <button id="deletePlaceBtn" class="danger">ê°€ê²Œ ì‚­ì œ</button>
        </div>
        <div class="hint" style="margin-top:10px">
          ì‚­ì œ ì‹œ í•´ë‹¹ ê°€ê²Œì˜ ë°©ë¬¸ê¸°ë¡ë„ í•¨ê»˜ ì‚­ì œë¼.
        </div>
      </div>
    </div>
  </aside>

  <!-- Add place modal -->
  <div id="addOverlay" class="overlay">
    <div class="modal">
      <div class="modalHeader">
        <h3>ìŒì‹ì  ì¶”ê°€</h3>
        <button id="closeAddBtn">ë‹«ê¸°</button>
      </div>
      <div class="modalBody">
        <div class="grid" style="grid-template-columns:1fr 1fr">
          <div>
            <label>ê°€ê²Œ ì´ë¦„</label>
            <input id="newName" placeholder="ì˜ˆ: í…í‚¤ë¼ë©˜" />
          </div>
          <div>
            <label>ì£¼ì†Œ(ê²€ìƒ‰ì–´)</label>
            <input id="newAddr" placeholder="ì˜ˆ: ê°•ë‚¨ ë…¼í˜„ë¡œ30ê¸¸ 43" />
          </div>
        </div>

        <div class="row" style="justify-content:flex-start;margin-top:10px">
          <button id="addrSearchBtn" class="primary">ì£¼ì†Œ í›„ë³´ ë³´ê¸°</button>
          <span id="geoStatus" class="hint"></span>
        </div>

        <div class="hint" style="margin-top:8px">
          ì¤‘ë³µ ì²´í¬: (ì´ë¦„+ì£¼ì†Œ) + (ì¢Œí‘œ 30m ê·¼ì ‘). ì´ë¯¸ ìˆìœ¼ë©´ ì•ˆë‚´ í›„ ì´ë™.
        </div>

        <div id="results" class="results"></div>
      </div>
    </div>
  </div>

  <!-- Login modal -->
  <div id="loginOverlay" class="overlay">
    <div class="modal" style="width:min(560px,96vw)">
      <div class="modalHeader">
        <h3>ë¡œê·¸ì¸</h3>
        <button id="closeLoginBtn">ë‹«ê¸°</button>
      </div>
      <div class="modalBody">
        <div class="cardItem">
          <label>ì´ë©”ì¼</label>
          <input id="loginEmail" type="email" placeholder="you@example.com" />
          <label>ë¹„ë°€ë²ˆí˜¸</label>
          <input id="loginPassword" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
          <div class="row">
            <button id="loginBtn" class="primary">ë¡œê·¸ì¸</button>
          </div>
          <div class="hint" style="margin-top:10px">ì—ëŸ¬ê°€ ë‚˜ë©´ í† ìŠ¤íŠ¸ ë©”ì‹œì§€ë¡œ ì´ìœ ê°€ ë‚˜ì™€.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Signup modal -->
  <div id="signupOverlay" class="overlay">
    <div class="modal" style="width:min(600px,96vw)">
      <div class="modalHeader">
        <h3>íšŒì›ê°€ì…</h3>
        <button id="closeSignupBtn">ë‹«ê¸°</button>
      </div>
      <div class="modalBody">
        <div class="cardItem">
          <label>ë‹‰ë„¤ì„ (í•„ìˆ˜, ì¤‘ë³µ ë¶ˆê°€)</label>
          <input id="signupNickname" placeholder="ì˜ˆ: jaewon" maxlength="20" />
          <label>ì´ë©”ì¼</label>
          <input id="signupEmail" type="email" placeholder="you@example.com" />
          <label>ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)</label>
          <input id="signupPassword" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
          <div class="row">
            <button id="signupBtn" class="primary">íšŒì›ê°€ì…</button>
          </div>
          <div class="hint" style="margin-top:10px">ì´ë©”ì¼ ì¸ì¦ ì„¤ì •ì— ë”°ë¼ ê°€ì… í›„ ë©”ì¼ í™•ì¸ì´ í•„ìš”í•  ìˆ˜ ìˆì–´.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Account modal -->
  <div id="accountOverlay" class="overlay">
    <div class="modal" style="width:min(700px,96vw)">
      <div class="modalHeader">
        <h3>ê³„ì •</h3>
        <button id="closeAccountBtn">ë‹«ê¸°</button>
      </div>
      <div class="modalBody">
        <div class="cardItem">
          <div class="hint">í˜„ì¬ ë¡œê·¸ì¸</div>
          <div id="accountLine" style="font-weight:950;margin-top:6px"></div>

          <div style="margin-top:12px">
            <label>ë‹‰ë„¤ì„</label>
            <input id="nickname" maxlength="20" />
            <div class="row">
              <button id="saveNickBtn" class="primary">ë‹‰ë„¤ì„ ì €ì¥</button>
              <button id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
            <div class="hint" style="margin-top:8px">ì €ì¥ í›„ ë°”ë¡œ ì¶”ê°€/ì‘ì„± ê°€ëŠ¥í•´ì•¼ ì •ìƒ.</div>
          </div>

          <div style="margin-top:14px">
            <div class="hint" style="margin-bottom:8px">ë‚´ í†µê³„</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
              <div class="cardItem" style="margin:0">
                <div class="hint">ë‚´ê°€ ì¶”ê°€í•œ ê°€ê²Œ</div>
                <div style="font-size:20px;font-weight:950;margin-top:6px" id="myPlacesCount">-</div>
              </div>
              <div class="cardItem" style="margin:0">
                <div class="hint">ë‚´ê°€ ë‚¨ê¸´ ë°©ë¬¸ê¸°</div>
                <div style="font-size:20px;font-weight:950;margin-top:6px" id="myVisitsCount">-</div>
              </div>
            </div>
          </div>

          <div class="hint" style="margin-top:10px">
            ë‹‰ë„¤ì„ì´ ë¹„ì–´ ìˆìœ¼ë©´ â€œì¶”ê°€/ì‘ì„±/ìˆ˜ì •/ì‚­ì œâ€ê°€ ë§‰í˜€.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"><span class="dot"></span><span id="toastText">.</span></div>

<script>
/*********** êµì²´ ***********/
const SB_URL = "https://tqybsmrmzxnfuwypbazn.supabase.co";
const SB_KEY = "sb_publishable_NOdwos9jU0jwL0AzvZrHHg_KSH5f2e1";
/****************************/

const $ = (id) => document.getElementById(id);
const esc = (s)=>String(s??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;");
const todayISO = () => new Date().toISOString().slice(0,10);

function toast(msg){
  $('toastText').textContent = msg;
  $('toast').classList.add('show');
  clearTimeout(toast._tm);
  toast._tm = setTimeout(()=> $('toast').classList.remove('show'), 2600);
}
function open(el){ el.classList.add('open'); }
function close(el){ el.classList.remove('open'); }
function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

const state = {
  sb: null,
  sbReady: false,

  user: null,
  myProfile: null,
  nameByUserId: new Map(),

  map: null,
  geocoder: null,

  places: [],
  markers: new Map(),        // placeId -> Marker
  visitCounts: new Map(),    // placeId -> count
  avgRatings: new Map(),     // placeId -> avg rating (null if none)

  selectedPlace: null,
  history: [],               // previous selections (for â—€)

  // windows
  visits: { pin:false, placeId:null },
  editor: { pin:false, placeId:null },
  place:  { placeId:null },

  editingVisitId: null,

  markerImageCache: new Map(),
  zTop: 1600,

  addBusy: false,
  placeBusy: false
};

function configured(){
  return SB_URL && SB_KEY && !SB_URL.includes("YOUR_") && !SB_KEY.includes("YOUR_");
}
function requireSb(){
  if(!state.sbReady || !state.sb){
    toast('ì´ˆê¸°í™” ì¤‘â€¦ ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ');
    return false;
  }
  return true;
}

function getMyNickname(){
  const a = (state.myProfile?.nickname || '').trim();
  if(a) return a;
  const b = (state.user?.user_metadata?.nickname || '').trim();
  if(b) return b;
  return '';
}
function hasNickname(){ return !!getMyNickname(); }

function requireNicknameOrGuide(){
  if(!requireSb()) return false;
  if(!state.user){
    toast('ë¡œê·¸ì¸ í•„ìš”');
    open($('loginOverlay'));
    return false;
  }
  if(!hasNickname()){
    toast('ë‹‰ë„¤ì„ì´ í•„ìš”í•´. ê³„ì •ì—ì„œ ì €ì¥í•´ì¤˜.');
    open($('accountOverlay'));
    return false;
  }
  return true;
}

function displayName(user_id, fallbackEmail){
  const nick = state.nameByUserId.get(user_id);
  if(nick && String(nick).trim()) return nick;
  if(fallbackEmail) return fallbackEmail;
  return 'user';
}

function bringToFront(el){
  state.zTop += 1;
  el.style.zIndex = String(state.zTop);
}

function setPinUI(btn, isOn){
  btn.classList.toggle('pinOn', !!isOn);
  btn.textContent = isOn ? 'ğŸ“Œ ON' : 'ğŸ“Œ';
}

/* ===== draggable windows ===== */
function makeDraggable(winEl, barEl){
  let dragging = false;
  let startX=0, startY=0, startLeft=0, startTop=0;

  const onDown = (e)=>{
    if(e.target.closest('button') || e.target.closest('input') || e.target.closest('textarea')) return;
    if(e.button !== 0) return;

    dragging = true;
    bringToFront(winEl);
    barEl.setPointerCapture(e.pointerId);

    startX = e.clientX;
    startY = e.clientY;

    const r = winEl.getBoundingClientRect();
    startLeft = r.left;
    startTop  = r.top;
  };

  const onMove = (e)=>{
    if(!dragging) return;
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;

    const r = winEl.getBoundingClientRect();
    const newLeft = clamp(startLeft + dx, 8, window.innerWidth - r.width - 8);
    const newTop  = clamp(startTop + dy, 8, window.innerHeight - r.height - 8);

    winEl.style.left = newLeft + 'px';
    winEl.style.top  = newTop + 'px';
    winEl.style.right = 'auto';
  };

  const onUp = (e)=>{
    if(!dragging) return;
    dragging = false;
    try{ barEl.releasePointerCapture(e.pointerId); } catch {}
  };

  barEl.addEventListener('pointerdown', onDown);
  barEl.addEventListener('pointermove', onMove);
  barEl.addEventListener('pointerup', onUp);
  barEl.addEventListener('pointercancel', onUp);
}

/* ===== Kakao Map ===== */
function initMap(){
  if(!(window.kakao && window.kakao.maps)){
    toast('ì¹´ì¹´ì˜¤ ì§€ë„ SDK ë¡œë”© ì‹¤íŒ¨ (í‚¤/ë„ë©”ì¸/ì¹´ì¹´ì˜¤ë§µ ON í™•ì¸)');
    return;
  }
  const center = new kakao.maps.LatLng(37.5665, 126.9780);
  state.map = new kakao.maps.Map($('map'), { center, level: 6 });
  state.geocoder = new kakao.maps.services.Geocoder();
}

/* ===== Place Bar (fixed UI above dock) ===== */
function updatePlaceBar(){
  const has = !!state.selectedPlace;
  const pbName = $('pbName');
  const pbAddr = $('pbAddr');
  const pbMeta = $('pbMeta');

  $('pbVisitsBtn').disabled = !has;
  $('pbWriteBtn').disabled  = !has;
  $('prevPlaceBtn').disabled = state.history.length === 0;
  $('nextPlaceBtn').disabled = state.places.length <= 1;

  if(!has){
    pbName.textContent = 'ê°€ê²Œ ì„ íƒ';
    pbAddr.textContent = 'ë§ˆì»¤ë¥¼ ëˆ„ë¥´ê±°ë‚˜ â–¶ë¡œ ëœë¤ ì´ë™';
    pbMeta.innerHTML = '';
    $('pbManageBtn').style.display = 'none';
    return;
  }

  const p = state.selectedPlace;
  const author = displayName(p.user_id);
  const cnt = state.visitCounts.get(p.id) || 0;
  const avg = state.avgRatings.get(p.id);
  const avgText = (avg == null) ? 'í‰ì  ì—†ìŒ' : `í‰ê·  ${avg.toFixed(1)}`;
  const hot = (avg != null && avg >= 4.0);

  pbName.textContent = p.name;
  pbAddr.textContent = p.address;

  pbMeta.innerHTML = `
    <span>ì¶”ê°€ì: ${esc(author)}</span>
    <span>ë°©ë¬¸ê¸°: ${cnt}ê°œ</span>
    <span>${hot ? 'â¤ï¸ ' : ''}${esc(avgText)}</span>
  `;

  const isMine = !!(state.user && p.user_id === state.user.id);
  $('pbManageBtn').style.display = isMine ? 'inline-flex' : 'none';
}

function panToSelectedPlace(){
  if(!state.map || !state.selectedPlace) return;
  const pos = new kakao.maps.LatLng(state.selectedPlace.lat, state.selectedPlace.lng);
  // Smooth move (no instant snap)
  state.map.panTo(pos);
}

async function setSelectedPlace(placeId, { pushHistory=false, pan=true } = {}){
  const p = state.places.find(x => x.id === placeId);
  if(!p) return;

  if(pushHistory && state.selectedPlace && state.selectedPlace.id !== placeId){
    state.history.push(state.selectedPlace.id);
  }

  state.selectedPlace = p;
  await fetchNicknames([p.user_id]);

  updatePlaceBar();
  refreshMarkerImages();

  if(pan) panToSelectedPlace();
}

async function gotoRandomNext(){
  if(state.places.length <= 1) return;

  const cur = state.selectedPlace?.id;
  const candidates = state.places.filter(p => p.id !== cur);
  if(candidates.length === 0) return;

  const pick = candidates[Math.floor(Math.random() * candidates.length)];
  await setSelectedPlace(pick.id, { pushHistory:true, pan:true });
}

async function gotoPrev(){
  if(state.history.length === 0){ toast('ì´ì „ ê¸°ë¡ ì—†ìŒ'); return; }
  const prevId = state.history.pop();
  await setSelectedPlace(prevId, { pushHistory:false, pan:true });
}

/* ===== Heart marker SVG (NO shadow, inverted ring/bg) ===== */
function svgHeartMarker({ size, heartFill, heartStroke, heartFillOn, selected }){
  const S = size;
  const cx = S/2, cy = S/2;

  const heartPath = `
    M ${S*0.50} ${S*0.78}
    C ${S*0.18} ${S*0.60}, ${S*0.18} ${S*0.34}, ${S*0.34} ${S*0.26}
    C ${S*0.45} ${S*0.20}, ${S*0.49} ${S*0.28}, ${S*0.50} ${S*0.33}
    C ${S*0.51} ${S*0.28}, ${S*0.55} ${S*0.20}, ${S*0.66} ${S*0.26}
    C ${S*0.82} ${S*0.34}, ${S*0.82} ${S*0.60}, ${S*0.50} ${S*0.78}
    Z
  `.trim();

  // inverted: light body, dark border
  const circleFill = 'rgba(255,255,255,.93)';
  const circleStroke = 'rgba(18,20,28,.92)';

  // selection: ONLY â€œfill heartâ€ (no size bump)
  const fill = selected ? heartFillOn : heartFill;

  const svg = `
  <svg xmlns="http://www.w3.org/2000/svg" width="${S}" height="${S}" viewBox="0 0 ${S} ${S}">
    <circle cx="${cx}" cy="${cy}" r="${S*0.42}" fill="${circleFill}" stroke="${circleStroke}" stroke-width="${Math.max(1.8, S*0.06)}"/>
    <path d="${heartPath}" fill="${fill}" stroke="${heartStroke}" stroke-width="${Math.max(2.0, S*0.075)}" stroke-linejoin="round"/>
  </svg>`;
  return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg.trim());
}

function countBucket(c){
  if(c<=0) return '0';
  if(c<=2) return '1';
  if(c<=5) return '2';
  return '3';
}

function markerImageForPlace(placeId){
  const count = state.visitCounts.get(placeId) || 0;
  const avg = state.avgRatings.get(placeId);
  const selected = state.selectedPlace?.id === placeId;

  // size depends ONLY on visit count (NOT selection)
  let size = 24;
  if(count === 0) size = 24;
  else if(count <= 2) size = 30;
  else if(count <= 5) size = 36;
  else size = 44;

  // heart color:
  // - avg >= 4.0 => RED heart (requested)
  // - else color by visit count bucket
  let stroke = 'rgba(18,20,28,.92)';
  let fillOff = 'none';
  let fillOn  = 'rgba(18,20,28,.92)'; // selection fill (for empty hearts)

  const hot = (avg != null && avg >= 4.0);
  if(hot){
    stroke = 'rgba(255,77,109,.98)';
    fillOff = 'rgba(255,77,109,.92)';
    fillOn  = 'rgba(255,77,109,.92)';
  } else {
    if(count === 0){
      stroke = 'rgba(18,20,28,.82)';
      fillOff = 'none';
      fillOn  = 'rgba(18,20,28,.90)'; // selected: filled heart
    } else if(count <= 2){
      stroke = 'rgba(106,166,255,.98)';
      fillOff = 'rgba(106,166,255,.92)';
      fillOn  = 'rgba(106,166,255,.92)';
    } else if(count <= 5){
      stroke = 'rgba(160,107,255,.98)';
      fillOff = 'rgba(160,107,255,.92)';
      fillOn  = 'rgba(160,107,255,.92)';
    } else {
      // 6+ : bigger is the main signal, keep deep tone
      stroke = 'rgba(18,20,28,.92)';
      fillOff = 'rgba(18,20,28,.88)';
      fillOn  = 'rgba(18,20,28,.88)';
    }
  }

  const key = `heart:${countBucket(count)}:${hot?'hot':'n'}:${selected?'sel':'n'}:${size}`;
  if(state.markerImageCache.has(key)) return state.markerImageCache.get(key);

  const url = svgHeartMarker({ size, heartFill: fillOff, heartStroke: stroke, heartFillOn: fillOn, selected });
  const img = new kakao.maps.MarkerImage(
    url,
    new kakao.maps.Size(size, size),
    { offset: new kakao.maps.Point(size/2, size/2) }
  );
  state.markerImageCache.set(key, img);
  return img;
}

function refreshMarkerImages(){
  for(const [pid, marker] of state.markers.entries()){
    marker.setImage(markerImageForPlace(pid));
  }
}

/* ===== Supabase ===== */
async function initSupabase(){
  if(!configured()){ toast('Supabase URL/KEYë¥¼ index.htmlì— ë„£ì–´ì¤˜'); return; }
  if(!window.supabase?.createClient){ toast('Supabase SDK ë¡œë”© ì‹¤íŒ¨'); return; }

  state.sb = window.supabase.createClient(SB_URL, SB_KEY, {
    auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
  });
  state.sbReady = true;

  const { data } = await state.sb.auth.getSession();
  state.user = data?.session?.user ?? null;

  if(state.user) await afterLoginOrRefresh();
  updateDockUI();

  state.sb.auth.onAuthStateChange(async (_event, session) => {
    state.user = session?.user ?? null;
    state.myProfile = null;

    if(state.user){
      await afterLoginOrRefresh();
    }else{
      $('myPlacesCount').textContent = '-';
      $('myVisitsCount').textContent = '-';
      updateDockUI();
      updatePlaceBar();
      refreshMarkerImages();
    }
  });
}

async function afterLoginOrRefresh(){
  await ensureMyProfile();
  await loadMyStats();
  updateDockUI();
  updatePlaceBar();
  refreshMarkerImages();
}

async function fetchNicknames(userIds){
  const ids = [...new Set((userIds || []).filter(Boolean))].filter(id => !state.nameByUserId.has(id));
  if(ids.length === 0) return;

  const { data, error } = await state.sb
    .from('profiles')
    .select('id, nickname')
    .in('id', ids);

  if(error){ console.error(error); return; }
  for(const row of (data ?? [])){
    state.nameByUserId.set(row.id, row.nickname || '');
  }
}

async function upsertMyProfile(nickname){
  const u = state.user;
  if(!u) return;

  const nick = (nickname ?? u.user_metadata?.nickname ?? '').trim();
  const payload = { id: u.id, nickname: nick || null };

  const { data, error } = await state.sb
    .from('profiles')
    .upsert(payload, { onConflict: 'id' })
    .select('id, nickname')
    .single();

  if(error){
    console.error(error);
    state.myProfile = { id: u.id, nickname: nick };
    state.nameByUserId.set(u.id, nick);
    return;
  }
  state.myProfile = data;
  state.nameByUserId.set(u.id, data.nickname || '');
}

async function ensureMyProfile(){
  const u = state.user;
  if(!u) return;

  const { data, error } = await state.sb
    .from('profiles')
    .select('id, nickname')
    .eq('id', u.id)
    .maybeSingle();

  if(error){
    console.error(error);
    await upsertMyProfile(u.user_metadata?.nickname || '');
    return;
  }
  if(!data){
    await upsertMyProfile(u.user_metadata?.nickname || '');
    return;
  }
  state.myProfile = data;
  state.nameByUserId.set(u.id, data.nickname || '');
}

async function loadMyStats(){
  if(!state.user) return;

  const p = await state.sb
    .from('places')
    .select('id', { count:'exact', head:true })
    .eq('user_id', state.user.id);

  const v = await state.sb
    .from('visits')
    .select('id', { count:'exact', head:true })
    .eq('user_id', state.user.id);

  $('myPlacesCount').textContent = String(p.count ?? 0);
  $('myVisitsCount').textContent = String(v.count ?? 0);
}

function updateDockUI(){
  const loggedIn = !!state.user;
  $('loginOpenBtn').style.display = loggedIn ? 'none' : 'inline-flex';
  $('signupOpenBtn').style.display = loggedIn ? 'none' : 'inline-flex';
  $('accountOpenBtn').style.display = loggedIn ? 'inline-flex' : 'none';
  if(loggedIn){
    $('accountOpenBtn').textContent = getMyNickname() ? getMyNickname() : 'ê³„ì •';
  }
}

async function loadPlaces(){
  const { data, error } = await state.sb
    .from('places')
    .select('*')
    .order('created_at', { ascending:false });

  if(error){ console.error(error); toast('places ë¡œë”© ì‹¤íŒ¨'); return; }
  state.places = data ?? [];
  await fetchNicknames(state.places.map(p => p.user_id));
}

async function loadVisitStats(){
  // counts + avg ratings in one pass
  const { data, error } = await state.sb
    .from('visits')
    .select('place_id, rating');

  if(error){
    console.error(error);
    state.visitCounts = new Map();
    state.avgRatings = new Map();
    return;
  }

  const counts = new Map();
  const sum = new Map();
  const n = new Map();

  for(const row of (data ?? [])){
    const pid = row.place_id;
    counts.set(pid, (counts.get(pid) || 0) + 1);

    if(row.rating != null){
      sum.set(pid, (sum.get(pid) || 0) + Number(row.rating));
      n.set(pid, (n.get(pid) || 0) + 1);
    }
  }

  const avgs = new Map();
  for(const [pid, c] of counts.entries()){
    const nn = n.get(pid) || 0;
    if(nn === 0) avgs.set(pid, null);
    else avgs.set(pid, (sum.get(pid) || 0) / nn);
  }

  state.visitCounts = counts;
  state.avgRatings = avgs;
}

async function recomputePlaceStats(placeId){
  const { data, error } = await state.sb
    .from('visits')
    .select('rating')
    .eq('place_id', placeId);

  if(error){ console.error(error); return; }

  const list = data ?? [];
  state.visitCounts.set(placeId, list.length);

  let s = 0, nn = 0;
  for(const v of list){
    if(v.rating != null){
      s += Number(v.rating);
      nn += 1;
    }
  }
  state.avgRatings.set(placeId, nn ? (s / nn) : null);

  updatePlaceBar();
  refreshMarkerImages();
}

/* ===== Marker handling ===== */
function clearMarkers(){
  for(const m of state.markers.values()) m.setMap(null);
  state.markers.clear();
}

function renderMarkers(){
  if(!state.map) return;
  clearMarkers();

  for(const p of state.places){
    const marker = new kakao.maps.Marker({
      position: new kakao.maps.LatLng(p.lat, p.lng),
      image: markerImageForPlace(p.id)
    });
    marker.setMap(state.map);

    kakao.maps.event.addListener(marker, 'click', async () => {
      // click -> update bottom bar selection + smooth pan
      await setSelectedPlace(p.id, { pushHistory:true, pan:true });
    });

    state.markers.set(p.id, marker);
  }
}

/* ===== Visits / Editor / Manage ===== */
function isVisitsOpen(){ return $('visitsWin').style.display !== 'none'; }
function isEditorOpen(){ return $('editorWin').style.display !== 'none'; }

async function openVisitsForSelected(){
  if(!state.selectedPlace){ toast('ê°€ê²Œ ì„ íƒ í•„ìš”'); return; }
  await openVisitsForPlace(state.selectedPlace.id);
}

async function openEditorForSelected(){
  if(!requireNicknameOrGuide()) return;
  if(!state.selectedPlace){ toast('ê°€ê²Œ ì„ íƒ í•„ìš”'); return; }
  await openEditorForPlace(state.selectedPlace.id);
}

async function openManageForSelected(){
  if(!requireNicknameOrGuide()) return;
  if(!state.selectedPlace){ toast('ê°€ê²Œ ì„ íƒ í•„ìš”'); return; }
  await openPlaceManage(state.selectedPlace.id);
}

async function openVisitsForPlace(placeId){
  const place = state.places.find(p => p.id === placeId);
  if(!place){ toast('ê°€ê²Œë¥¼ ì°¾ì§€ ëª»í•¨'); return; }

  if(isVisitsOpen() && state.visits.pin && state.visits.placeId && state.visits.placeId !== placeId){
    toast('ê¸°ë¡ ì°½ì´ í•€ ê³ ì •ë¨. í•€ í•´ì œ í›„ ë‹¤ë¥¸ ê°€ê²Œ ê¸°ë¡ ì—´ê¸°.');
    return;
  }

  state.visits.placeId = placeId;

  const win = $('visitsWin');
  bringToFront(win);
  win.style.display = 'block';

  $('visitsTitle').textContent = `ë°©ë¬¸ ê¸°ë¡ Â· ${place.name}`;
  $('visitsHint').textContent = 'ìˆ˜ì •/ì‚­ì œëŠ” ë³¸ì¸ë§Œ.';

  await loadVisitsAndRender(placeId);
}

async function openEditorForPlace(placeId){
  if(!requireNicknameOrGuide()) return;

  if(isEditorOpen() && state.editor.pin && state.editor.placeId && state.editor.placeId !== placeId){
    toast('ì‘ì„± ì°½ì´ í•€ ê³ ì •ë¨. í•€ í•´ì œ í›„ ë‹¤ë¥¸ ê°€ê²Œ ì‘ì„± ê°€ëŠ¥.');
    return;
  }

  const place = state.places.find(p => p.id === placeId);
  if(!place){ toast('ê°€ê²Œë¥¼ ì°¾ì§€ ëª»í•¨'); return; }

  state.editor.placeId = placeId;
  state.editingVisitId = null;

  $('editorTitle').textContent = `ë°©ë¬¸ê¸° ì‘ì„± Â· ${place.name}`;
  $('saveVisitBtn').textContent = 'ì €ì¥';
  $('cancelEditBtn').style.display = 'none';
  $('visitDate').value = todayISO();
  $('visitRating').value = '';
  $('visitContent').value = '';

  const win = $('editorWin');
  bringToFront(win);
  win.style.display = 'block';
}

async function loadVisitsAndRender(placeId){
  const wrap = $('visits');
  wrap.innerHTML = '<div class="hint">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';

  const { data, error } = await state.sb
    .from('visits')
    .select('*')
    .eq('place_id', placeId)
    .order('visited_at', { ascending:false })
    .order('created_at', { ascending:false });

  if(error){ console.error(error); toast('visits ë¡œë”© ì‹¤íŒ¨'); wrap.innerHTML=''; return; }

  const items = data ?? [];
  await fetchNicknames(items.map(v => v.user_id));

  if(items.length === 0){
    wrap.innerHTML = '<div class="hint">ì•„ì§ ë°©ë¬¸ ê¸°ë¡ ì—†ìŒ.</div>';
    return;
  }

  wrap.innerHTML = '';
  for(const v of items){
    const author = displayName(v.user_id, v.author_email);
    const isMine = !!(state.user && v.user_id === state.user.id);

    const div = document.createElement('div');
    div.className = 'cardItem';
    div.innerHTML = `
      <div class="visitTop">
        <div style="font-weight:950">${esc(v.visited_at)}</div>
        <div class="badge">${v.rating == null ? 'í‰ì  ì—†ìŒ' : ('í‰ì  ' + esc(v.rating))}</div>
      </div>
      <div class="sub" style="margin-top:6px">ì‘ì„±ì: ${esc(author)}</div>
      <div class="visitContent">${esc(v.content || '')}</div>
      ${isMine ? `
        <div class="miniActions">
          <button data-act="edit">ìˆ˜ì •</button>
          <button data-act="del">ì‚­ì œ</button>
        </div>
      ` : ''}
    `;

    if(isMine){
      div.querySelector('[data-act="edit"]').addEventListener('click', async ()=>{
        if(!requireNicknameOrGuide()) return;

        if(isEditorOpen() && state.editor.pin && state.editor.placeId && state.editor.placeId !== v.place_id){
          toast('ì‘ì„± ì°½ì´ í•€ ê³ ì •ë¨. í•€ í•´ì œ í›„ ìˆ˜ì • ê°€ëŠ¥.');
          return;
        }

        state.editingVisitId = v.id;
        state.editor.placeId = v.place_id;

        const place = state.places.find(p => p.id === v.place_id);
        $('editorTitle').textContent = `ë°©ë¬¸ê¸° ìˆ˜ì • Â· ${place ? place.name : ''}`;
        $('saveVisitBtn').textContent = 'ìˆ˜ì • ì €ì¥';
        $('cancelEditBtn').style.display = 'inline-flex';

        $('visitDate').value = v.visited_at || todayISO();
        $('visitRating').value = (v.rating ?? '');
        $('visitContent').value = v.content || '';

        const win = $('editorWin');
        bringToFront(win);
        win.style.display = 'block';
      });

      div.querySelector('[data-act="del"]').addEventListener('click', async ()=>{
        if(!requireNicknameOrGuide()) return;
        if(!confirm('ì´ ë°©ë¬¸ê¸°ë¥¼ ì‚­ì œí• ê¹Œ?')) return;

        const { error } = await state.sb.from('visits').delete().eq('id', v.id);
        if(error){ console.error(error); toast(error.message || 'ì‚­ì œ ì‹¤íŒ¨'); return; }

        toast('ì‚­ì œë¨');
        await recomputePlaceStats(placeId);
        await loadVisitsAndRender(placeId);
        await loadMyStats();
      });
    }

    wrap.appendChild(div);
  }
}

async function saveVisit(){
  if(!requireNicknameOrGuide()) return;

  const placeId = state.editor.placeId;
  if(!placeId){ toast('ê°€ê²Œ ì„ íƒ í•„ìš”'); return; }

  const visited_at = $('visitDate').value || todayISO();
  const ratingRaw = $('visitRating').value;
  const rating = (ratingRaw === '') ? null : Math.max(0, Math.min(5, Number(ratingRaw)));
  const content = ($('visitContent').value || '').trim();
  if(!content){ toast('ë°©ë¬¸ê¸° ë‚´ìš©ì„ ì¨ì¤˜'); return; }

  $('saveVisitBtn').disabled = true;
  try{
    if(state.editingVisitId){
      const { error } = await state.sb
        .from('visits')
        .update({ visited_at, rating, content })
        .eq('id', state.editingVisitId);

      if(error){ console.error(error); toast(error.message || 'ìˆ˜ì • ì‹¤íŒ¨'); return; }
      toast('ìˆ˜ì •ë¨');

      state.editingVisitId = null;
      $('cancelEditBtn').style.display = 'none';
      $('saveVisitBtn').textContent = 'ì €ì¥';

      const place = state.places.find(p => p.id === placeId);
      $('editorTitle').textContent = `ë°©ë¬¸ê¸° ì‘ì„± Â· ${place ? place.name : ''}`;
    }else{
      const payload = {
        user_id: state.user.id,
        author_email: state.user.email || null,
        place_id: placeId,
        visited_at,
        rating,
        content
      };

      const { error } = await state.sb.from('visits').insert(payload);
      if(error){ console.error(error); toast(error.message || 'ì €ì¥ ì‹¤íŒ¨'); return; }

      toast('ì €ì¥ë¨');
      $('visitContent').value = '';
      $('visitRating').value = '';
    }

    await recomputePlaceStats(placeId);
    await loadMyStats();

    if(isVisitsOpen() && state.visits.placeId === placeId){
      await loadVisitsAndRender(placeId);
    }
  } finally {
    $('saveVisitBtn').disabled = false;
  }
}

/* ===== Place edit/delete + duplicate guard ===== */
function haversineMeters(lat1,lng1,lat2,lng2){
  const R = 6371000;
  const toRad = (x)=> x*Math.PI/180;
  const dLat = toRad(lat2-lat1);
  const dLng = toRad(lng2-lng1);
  const a = Math.sin(dLat/2)**2 +
            Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*(Math.sin(dLng/2)**2);
  const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}
function isSeoulByCoord(lat, lng){
  return new Promise((resolve) => {
    state.geocoder.coord2RegionCode(lng, lat, (res, status) => {
      if(status !== kakao.maps.services.Status.OK || !res || res.length === 0){
        resolve(true);
        return;
      }
      const any = res.find(x => x.region_1depth_name) || res[0];
      resolve((any.region_1depth_name || '').includes('ì„œìš¸'));
    });
  });
}

async function findDuplicateByNameAddress(name, address, excludeId=null){
  let q = state.sb.from('places').select('id, lat, lng').eq('name', name).eq('address', address).limit(5);
  if(excludeId) q = q.neq('id', excludeId);
  const { data, error } = await q;
  if(error){ console.error(error); return null; }
  return (data && data.length) ? data[0] : null;
}
async function findDuplicateByProximity(lat, lng, thresholdMeters = 30, excludeId=null){
  const dLat = 0.0006;
  const dLng = 0.00075;
  let q = state.sb
    .from('places')
    .select('id, lat, lng')
    .gte('lat', lat - dLat).lte('lat', lat + dLat)
    .gte('lng', lng - dLng).lte('lng', lng + dLng)
    .limit(60);
  if(excludeId) q = q.neq('id', excludeId);

  const { data, error } = await q;
  if(error){ console.error(error); return null; }

  let best=null, bestDist=Infinity;
  for(const p of (data ?? [])){
    const dist = haversineMeters(lat, lng, p.lat, p.lng);
    if(dist < bestDist){ bestDist=dist; best=p; }
  }
  if(best && bestDist <= thresholdMeters) return { ...best, dist: bestDist };
  return null;
}

async function createPlace({ name, address, lat, lng }){
  if(!requireNicknameOrGuide()) return null;

  const dup1 = await findDuplicateByNameAddress(name, address, null);
  if(dup1){
    toast('ì´ë¯¸ ë“±ë¡ëœ ê°€ê²Œì•¼. ê·¸ìª½ìœ¼ë¡œ ì´ë™í• ê²Œ.');
    return { id: dup1.id, existed:true };
  }
  const dup2 = await findDuplicateByProximity(lat, lng, 30, null);
  if(dup2){
    toast(`ê·¼ì²˜(${Math.round(dup2.dist)}m)ì— ì´ë¯¸ ë“±ë¡ëœ ê°€ê²Œê°€ ìˆì–´. ê·¸ìª½ìœ¼ë¡œ ì´ë™í• ê²Œ.`);
    return { id: dup2.id, existed:true };
  }

  const payload = { user_id: state.user.id, name, address, lat, lng };
  const { data, error } = await state.sb
    .from('places')
    .insert(payload)
    .select('*')
    .single();

  if(error){
    console.error(error);
    toast(error.message || 'ê°€ê²Œ ì €ì¥ ì‹¤íŒ¨');
    return null;
  }
  return { ...data, existed:false };
}

async function openPlaceManage(placeId){
  const place = state.places.find(p => p.id === placeId);
  if(!place){ toast('ê°€ê²Œë¥¼ ì°¾ì§€ ëª»í•¨'); return; }
  if(!(state.user && place.user_id === state.user.id)){
    toast('ì´ ê°€ê²ŒëŠ” ë„ˆê°€ ì¶”ê°€í•œ ê²Œ ì•„ë‹ˆë¼ì„œ ìˆ˜ì •/ì‚­ì œ ë¶ˆê°€');
    return;
  }

  state.place.placeId = placeId;
  $('placeTitle').textContent = `ê°€ê²Œ ê´€ë¦¬ Â· ${place.name}`;
  $('editPlaceName').value = place.name || '';
  $('editPlaceAddr').value = place.address || '';
  $('placeGeoStatus').textContent = '';
  $('placeResults').innerHTML = '';

  const win = $('placeWin');
  bringToFront(win);
  win.style.display = 'block';
}

async function updatePlace(placeId, { name, address, lat, lng }){
  const old = state.places.find(p => p.id === placeId);
  if(!old) return null;

  const dup1 = await findDuplicateByNameAddress(name, address, placeId);
  if(dup1){
    toast('ì´ë¯¸ ë“±ë¡ëœ ê°€ê²Œ(ì´ë¦„+ì£¼ì†Œ)ê°€ ìˆì–´. ìˆ˜ì • ë¶ˆê°€.');
    return null;
  }
  const dup2 = await findDuplicateByProximity(lat, lng, 30, placeId);
  if(dup2){
    toast(`ê·¼ì²˜(${Math.round(dup2.dist)}m)ì— ë‹¤ë¥¸ ê°€ê²Œê°€ ìˆì–´. ìˆ˜ì • ë¶ˆê°€.`);
    return null;
  }

  const { data, error } = await state.sb
    .from('places')
    .update({ name, address, lat, lng })
    .eq('id', placeId)
    .select('*')
    .single();

  if(error){
    console.error(error);
    toast(error.message || 'ê°€ê²Œ ìˆ˜ì • ì‹¤íŒ¨');
    return null;
  }

  const idx = state.places.findIndex(p => p.id === placeId);
  if(idx >= 0) state.places[idx] = data;

  const mk = state.markers.get(placeId);
  if(mk){
    mk.setPosition(new kakao.maps.LatLng(data.lat, data.lng));
    mk.setImage(markerImageForPlace(placeId));
  }

  if(state.selectedPlace?.id === placeId){
    state.selectedPlace = data;
    updatePlaceBar();
  }

  toast('ê°€ê²Œ ìˆ˜ì •ë¨');
  return data;
}

async function deletePlace(placeId){
  const place = state.places.find(p => p.id === placeId);
  if(!place) return;
  if(!(state.user && place.user_id === state.user.id)){
    toast('ì´ ê°€ê²ŒëŠ” ë„ˆê°€ ì¶”ê°€í•œ ê²Œ ì•„ë‹ˆë¼ì„œ ì‚­ì œ ë¶ˆê°€');
    return;
  }
  if(!confirm('ì •ë§ ì´ ê°€ê²Œë¥¼ ì‚­ì œí• ê¹Œ? (ë°©ë¬¸ê¸°ë¡ë„ í•¨ê»˜ ì‚­ì œë¨)')) return;

  const delVisits = await state.sb.from('visits').delete().eq('place_id', placeId);
  if(delVisits.error){
    console.error(delVisits.error);
    toast(delVisits.error.message || 'ë°©ë¬¸ê¸° ì‚­ì œ ì‹¤íŒ¨');
    return;
  }

  const delPlace = await state.sb.from('places').delete().eq('id', placeId);
  if(delPlace.error){
    console.error(delPlace.error);
    toast(delPlace.error.message || 'ê°€ê²Œ ì‚­ì œ ì‹¤íŒ¨');
    return;
  }

  state.places = state.places.filter(p => p.id !== placeId);
  state.visitCounts.delete(placeId);
  state.avgRatings.delete(placeId);

  const mk = state.markers.get(placeId);
  if(mk) mk.setMap(null);
  state.markers.delete(placeId);

  if(state.selectedPlace?.id === placeId){
    state.selectedPlace = null;
    updatePlaceBar();
    refreshMarkerImages();
  }

  if(state.visits.placeId === placeId && !state.visits.pin){
    $('visitsWin').style.display = 'none';
    state.visits.placeId = null;
  }
  if(state.editor.placeId === placeId && !state.editor.pin){
    $('editorWin').style.display = 'none';
    state.editor.placeId = null;
  }
  $('placeWin').style.display = 'none';
  state.place.placeId = null;

  await loadMyStats();
  toast('ê°€ê²Œ ì‚­ì œë¨');
}

/* ===== Address search (geocoder) ===== */
function setAddBusy(b){
  state.addBusy = b;
  $('addrSearchBtn').disabled = b;
  $('closeAddBtn').disabled = b;
}
function setPlaceBusy(b){
  state.placeBusy = b;
  $('placeAddrSearchBtn').disabled = b;
  $('savePlaceBtn').disabled = b;
  $('deletePlaceBtn').disabled = b;
}

function renderAddressCandidates(containerEl, candidates, tag){
  containerEl.innerHTML = '';
  for(const c of candidates){
    const div = document.createElement('div');
    div.className = 'resultItem';
    div.dataset.tag = tag;
    div.dataset.lat = String(c.lat);
    div.dataset.lng = String(c.lng);
    div.dataset.addr = c.addr;
    div.dataset.name = c.name || '';
    div.innerHTML = `
      <div class="t">${esc(c.name || '')}</div>
      <div class="s">${esc(c.addr)}</div>
      <div class="s">ì¢Œí‘œ: ${c.lat.toFixed(5)}, ${c.lng.toFixed(5)}</div>
    `;
    containerEl.appendChild(div);
  }
}

async function searchAddress(q){
  return new Promise((resolve)=>{
    state.geocoder.addressSearch(q, (result, status) => {
      if(status !== kakao.maps.services.Status.OK || !result || result.length === 0){
        resolve([]);
        return;
      }
      const arr = result.slice(0, 8).map(r => ({
        lat: Number(r.y),
        lng: Number(r.x),
        addr: (r.address_name || q).trim()
      }));
      resolve(arr);
    });
  });
}

/* ===== UI events ===== */
window.addEventListener('DOMContentLoaded', () => {
  $('visitDate').value = todayISO();

  makeDraggable($('visitsWin'), $('visitsDragBar'));
  makeDraggable($('editorWin'), $('editorDragBar'));
  makeDraggable($('placeWin'), $('placeDragBar'));

  $('visitsWin').addEventListener('pointerdown', ()=> bringToFront($('visitsWin')));
  $('editorWin').addEventListener('pointerdown', ()=> bringToFront($('editorWin')));
  $('placeWin').addEventListener('pointerdown', ()=> bringToFront($('placeWin')));

  // pins
  setPinUI($('visitsPinBtn'), state.visits.pin);
  setPinUI($('editorPinBtn'), state.editor.pin);

  $('visitsPinBtn').addEventListener('click', ()=>{
    state.visits.pin = !state.visits.pin;
    setPinUI($('visitsPinBtn'), state.visits.pin);
    toast(state.visits.pin ? 'ê¸°ë¡ ì°½ í•€ ON' : 'ê¸°ë¡ ì°½ í•€ OFF');
  });
  $('editorPinBtn').addEventListener('click', ()=>{
    state.editor.pin = !state.editor.pin;
    setPinUI($('editorPinBtn'), state.editor.pin);
    toast(state.editor.pin ? 'ì‘ì„± ì°½ í•€ ON' : 'ì‘ì„± ì°½ í•€ OFF');
  });

  // close
  $('closeVisitsBtn').addEventListener('click', (e)=>{ e.stopPropagation(); $('visitsWin').style.display = 'none'; });
  $('closeEditorBtn').addEventListener('click', (e)=>{ e.stopPropagation(); $('editorWin').style.display = 'none'; });
  $('closePlaceBtn').addEventListener('click', (e)=>{ e.stopPropagation(); $('placeWin').style.display = 'none'; });

  // editor actions
  $('cancelEditBtn').addEventListener('click', ()=>{
    state.editingVisitId = null;
    $('cancelEditBtn').style.display = 'none';
    $('saveVisitBtn').textContent = 'ì €ì¥';
    const place = state.places.find(p => p.id === state.editor.placeId);
    $('editorTitle').textContent = `ë°©ë¬¸ê¸° ì‘ì„± Â· ${place ? place.name : ''}`;
    $('visitDate').value = todayISO();
    $('visitRating').value = '';
    $('visitContent').value = '';
    toast('í¸ì§‘ ì·¨ì†Œ');
  });
  $('saveVisitBtn').addEventListener('click', saveVisit);

  // placebar buttons
  $('pbVisitsBtn').addEventListener('click', openVisitsForSelected);
  $('pbWriteBtn').addEventListener('click', openEditorForSelected);
  $('pbManageBtn').addEventListener('click', openManageForSelected);
  $('nextPlaceBtn').addEventListener('click', gotoRandomNext);
  $('prevPlaceBtn').addEventListener('click', gotoPrev);

  // add flow
  $('addBtn').addEventListener('click', ()=>{
    if(!requireNicknameOrGuide()) return;
    $('results').innerHTML = '';
    $('geoStatus').textContent = '';
    open($('addOverlay'));
  });
  $('closeAddBtn').addEventListener('click', ()=> close($('addOverlay')));

  // auth modals
  $('loginOpenBtn').addEventListener('click', ()=> open($('loginOverlay')));
  $('closeLoginBtn').addEventListener('click', ()=> close($('loginOverlay')));
  $('signupOpenBtn').addEventListener('click', ()=> open($('signupOverlay')));
  $('closeSignupBtn').addEventListener('click', ()=> close($('signupOverlay')));

  $('accountOpenBtn').addEventListener('click', async ()=>{
    if(!requireSb()) return;
    open($('accountOverlay'));
    $('accountLine').textContent = state.user?.email || '';
    $('nickname').value = getMyNickname() || '';
    await loadMyStats();
  });
  $('closeAccountBtn').addEventListener('click', ()=> close($('accountOverlay')));

  // login
  $('loginBtn').addEventListener('click', async ()=>{
    if(!requireSb()) return;

    const email = ($('loginEmail').value || '').trim();
    const password = $('loginPassword').value || '';
    if(!email || !password){ toast('ì´ë©”ì¼/ë¹„ë²ˆ ì…ë ¥'); return; }

    $('loginBtn').disabled = true;
    try{
      const { error } = await state.sb.auth.signInWithPassword({ email, password });
      if(error){ console.error(error); toast(error.message || 'ë¡œê·¸ì¸ ì‹¤íŒ¨'); return; }

      toast('ë¡œê·¸ì¸ ë¨');
      close($('loginOverlay'));

      await afterLoginOrRefresh();
      await loadPlaces();
      await loadVisitStats();
      renderMarkers();
      refreshMarkerImages();
      updatePlaceBar();
    } finally {
      $('loginBtn').disabled = false;
    }
  });

  // signup
  $('signupBtn').addEventListener('click', async ()=>{
    if(!requireSb()) return;

    const nickname = ($('signupNickname').value || '').trim();
    const email = ($('signupEmail').value || '').trim();
    const password = $('signupPassword').value || '';

    if(!nickname){ toast('ë‹‰ë„¤ì„ì€ í•„ìˆ˜'); return; }
    if(!email || !password){ toast('ì´ë©”ì¼/ë¹„ë²ˆ ì…ë ¥'); return; }

    $('signupBtn').disabled = true;
    try{
      const { data, error } = await state.sb.auth.signUp({
        email, password,
        options: { data: { nickname } }
      });
      if(error){ console.error(error); toast(error.message || 'íšŒì›ê°€ì… ì‹¤íŒ¨'); return; }

      if(data?.session){
        toast('íšŒì›ê°€ì…+ë¡œê·¸ì¸ ì™„ë£Œ');
        close($('signupOverlay'));
        await afterLoginOrRefresh();
      } else {
        toast('íšŒì›ê°€ì… ì™„ë£Œ. ì´ë©”ì¼ ì¸ì¦ì´ í•„ìš”í•  ìˆ˜ ìˆì–´.');
        close($('signupOverlay'));
        open($('loginOverlay'));
      }
    } finally {
      $('signupBtn').disabled = false;
    }
  });

  // nickname save
  $('saveNickBtn').addEventListener('click', async ()=>{
    if(!requireSb()) return;
    if(!state.user){ toast('ë¡œê·¸ì¸ í•„ìš”'); return; }

    const nickname = ($('nickname').value || '').trim();
    if(!nickname){ toast('ë‹‰ë„¤ì„ì€ ë¹„ìš¸ ìˆ˜ ì—†ìŒ'); return; }

    $('saveNickBtn').disabled = true;
    try{
      await upsertMyProfile(nickname);
      try{
        await state.sb.auth.updateUser({ data: { nickname } });
        const { data } = await state.sb.auth.getSession();
        state.user = data?.session?.user ?? state.user;
      } catch {}

      await ensureMyProfile();
      toast('ë‹‰ë„¤ì„ ì €ì¥ë¨');
      updateDockUI();
      updatePlaceBar();
    } catch (e){
      console.error(e);
      toast('ë‹‰ë„¤ì„ ì €ì¥ ì‹¤íŒ¨(ì¤‘ë³µì¼ ìˆ˜ ìˆìŒ)');
    } finally {
      $('saveNickBtn').disabled = false;
    }
  });

  $('logoutBtn').addEventListener('click', async ()=>{
    if(!requireSb()) return;
    await state.sb.auth.signOut();
    toast('ë¡œê·¸ì•„ì›ƒ');
    close($('accountOverlay'));
    updateDockUI();
  });

  // add address search
  $('addrSearchBtn').addEventListener('click', async ()=>{
    if(!state.geocoder){ toast('ì§€ë„ ì¤€ë¹„ ì•ˆ ë¨'); return; }
    const name = ($('newName').value || '').trim();
    const q = ($('newAddr').value || '').trim();
    if(!name){ toast('ê°€ê²Œ ì´ë¦„ë¶€í„°'); return; }
    if(!q){ toast('ì£¼ì†Œ(ê²€ìƒ‰ì–´)ë¶€í„°'); return; }

    setAddBusy(true);
    $('geoStatus').textContent = 'ì°¾ëŠ” ì¤‘â€¦';
    try{
      const res = await searchAddress(q);
      if(res.length === 0){
        $('geoStatus').textContent = 'ê²°ê³¼ ì—†ìŒ';
        $('results').innerHTML = '';
        return;
      }
      $('geoStatus').textContent = `í›„ë³´ ${res.length}ê°œ`;
      renderAddressCandidates($('results'), res.map(x=>({ ...x, name })), 'add');
    } finally {
      setAddBusy(false);
    }
  });

  // results click (event delegation)
  $('results').addEventListener('click', async (e)=>{
    const item = e.target.closest('.resultItem');
    if(!item) return;
    if(state.addBusy) return;

    const name = (item.dataset.name || '').trim();
    const addr = (item.dataset.addr || '').trim();
    const lat = Number(item.dataset.lat);
    const lng = Number(item.dataset.lng);

    setAddBusy(true);
    try{
      const ok = await isSeoulByCoord(lat, lng);
      if(!ok){ toast('ì„œìš¸ì´ ì•„ë‹ˆë©´ ì €ì¥ ì•ˆ í•¨'); return; }

      const created = await createPlace({ name, address: addr, lat, lng });
      if(!created) return;

      close($('addOverlay'));
      $('newName').value = '';
      $('newAddr').value = '';
      $('results').innerHTML = '';
      $('geoStatus').textContent = '';

      if(created.existed){
        await loadPlaces();
        await loadVisitStats();
        renderMarkers();
        await setSelectedPlace(created.id, { pushHistory:true, pan:true });
        return;
      }

      // local update
      state.places.unshift(created);
      state.visitCounts.set(created.id, 0);
      state.avgRatings.set(created.id, null);

      // add marker
      const marker = new kakao.maps.Marker({
        position: new kakao.maps.LatLng(created.lat, created.lng),
        image: markerImageForPlace(created.id)
      });
      marker.setMap(state.map);
      kakao.maps.event.addListener(marker, 'click', async () => {
        await setSelectedPlace(created.id, { pushHistory:true, pan:true });
      });
      state.markers.set(created.id, marker);

      await loadMyStats();
      await setSelectedPlace(created.id, { pushHistory:true, pan:true });
      toast('ê°€ê²Œ ì¶”ê°€ë¨');
    } finally {
      setAddBusy(false);
    }
  });

  // place manage address search
  $('placeAddrSearchBtn').addEventListener('click', async ()=>{
    const pid = state.place.placeId;
    if(!pid) return;
    const name = ($('editPlaceName').value || '').trim();
    const q = ($('editPlaceAddr').value || '').trim();
    if(!name){ toast('ê°€ê²Œ ì´ë¦„ë¶€í„°'); return; }
    if(!q){ toast('ì£¼ì†Œë¶€í„°'); return; }

    setPlaceBusy(true);
    $('placeGeoStatus').textContent = 'ì°¾ëŠ” ì¤‘â€¦';
    try{
      const res = await searchAddress(q);
      if(res.length === 0){
        $('placeGeoStatus').textContent = 'ê²°ê³¼ ì—†ìŒ';
        $('placeResults').innerHTML = '';
        return;
      }
      $('placeGeoStatus').textContent = `í›„ë³´ ${res.length}ê°œ`;
      renderAddressCandidates($('placeResults'), res.map(x=>({ ...x, name })), 'place');
    } finally {
      setPlaceBusy(false);
    }
  });

  $('placeResults').addEventListener('click', (e)=>{
    const item = e.target.closest('.resultItem');
    if(!item) return;
    const addr = (item.dataset.addr || '').trim();
    $('editPlaceAddr').value = addr;
    $('placeResults').dataset.pickLat = item.dataset.lat;
    $('placeResults').dataset.pickLng = item.dataset.lng;
    toast('í›„ë³´ ì„ íƒë¨. ì´ì œ â€œìˆ˜ì • ì €ì¥â€');
  });

  $('savePlaceBtn').addEventListener('click', async ()=>{
    if(!requireNicknameOrGuide()) return;
    const pid = state.place.placeId;
    if(!pid) return;

    const place = state.places.find(p => p.id === pid);
    if(!place) return;

    const name = ($('editPlaceName').value || '').trim();
    const address = ($('editPlaceAddr').value || '').trim();
    if(!name || !address){ toast('ì´ë¦„/ì£¼ì†Œ í•„ìš”'); return; }

    const lat = $('placeResults').dataset.pickLat ? Number($('placeResults').dataset.pickLat) : place.lat;
    const lng = $('placeResults').dataset.pickLng ? Number($('placeResults').dataset.pickLng) : place.lng;

    setPlaceBusy(true);
    try{
      const ok = await isSeoulByCoord(lat, lng);
      if(!ok){ toast('ì„œìš¸ì´ ì•„ë‹ˆë©´ ì €ì¥ ì•ˆ í•¨'); return; }
      const updated = await updatePlace(pid, { name, address, lat, lng });
      if(!updated) return;

      $('placeTitle').textContent = `ê°€ê²Œ ê´€ë¦¬ Â· ${updated.name}`;
      $('placeResults').innerHTML = '';
      $('placeResults').dataset.pickLat = '';
      $('placeResults').dataset.pickLng = '';
    } finally {
      setPlaceBusy(false);
    }
  });

  $('deletePlaceBtn').addEventListener('click', async ()=>{
    if(!requireNicknameOrGuide()) return;
    const pid = state.place.placeId;
    if(!pid) return;
    setPlaceBusy(true);
    try{
      await deletePlace(pid);
    } finally {
      setPlaceBusy(false);
    }
  });

  // search (Enter) -> select + smooth pan
  $('q').addEventListener('keydown', async (e)=>{
    if(e.key !== 'Enter') return;
    const q = ($('q').value || '').trim().toLowerCase();
    if(!q) return;

    const hit = state.places.find(p =>
      (p.name || '').toLowerCase().includes(q) ||
      (p.address || '').toLowerCase().includes(q)
    );
    if(!hit){ toast('ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ'); return; }
    await setSelectedPlace(hit.id, { pushHistory:true, pan:true });
  });
});

/* ===== boot ===== */
window.addEventListener('load', async ()=>{
  initMap();
  await initSupabase();
  if(!state.sbReady) return;

  await loadPlaces();
  await loadVisitStats();
  renderMarkers();
  refreshMarkerImages();

  // ì´ˆê¸°ë¶€í„° place barì— ê°€ê²Œ ì •ë³´ë¥¼ ë³´ì—¬ì£¼ê¸° (ëœë¤ 1ê°œ ì„ íƒ, but panì€ ì•ˆ í•¨)
  if(state.places.length > 0){
    const initial = state.places[Math.floor(Math.random() * state.places.length)];
    await setSelectedPlace(initial.id, { pushHistory:false, pan:false });
  } else {
    state.selectedPlace = null;
    updatePlaceBar();
  }

  if(state.user){
    await afterLoginOrRefresh();
  } else {
    updateDockUI();
    updatePlaceBar();
  }
});
</script>
</body>
</html>
