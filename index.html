<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Seoul Shared Eats</title>

  <!-- Kakao Maps JS SDK (services í¬í•¨) -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=5c2fb05e6765f133c747e1f5a2bdf64d&libraries=services"></script>

  <!-- Supabase JS SDK (window.supabase) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0b0c10; --panel:#11131a; --card:#171a23;
      --text:#e9ecf1; --muted:#a7afbf; --line:#242a36;
      --accent:#7aa2ff; --shadow:0 10px 30px rgba(0,0,0,.35);
      --r:16px; --top:56px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:var(--bg);color:var(--text)}
    #map{position:fixed;left:0;right:0;top:var(--top);bottom:0}

    .topbar{
      position:fixed;left:0;right:0;top:0;height:var(--top);
      display:flex;align-items:center;gap:10px;padding:10px 12px;
      border-bottom:1px solid var(--line);
      background:rgba(11,12,16,.85);backdrop-filter:blur(10px);z-index:1000;
    }
    .brand{font-weight:800;letter-spacing:.2px;white-space:nowrap}
    .search{
      flex:1;max-width:760px;display:flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;border:1px solid var(--line);
      background:rgba(23,26,35,.75)
    }
    .search input{width:100%;border:0;outline:0;background:transparent;color:var(--text);font-size:14px}
    .search input::placeholder{color:rgba(167,175,191,.7)}

    button{
      border:1px solid var(--line);background:rgba(23,26,35,.75);color:var(--text);
      padding:10px 12px;border-radius:999px;cursor:pointer;
    }
    button.primary{background:rgba(122,162,255,.16);border-color:rgba(122,162,255,.45)}
    button:disabled{opacity:.55;cursor:not-allowed}

    .panel{
      position:fixed;top:var(--top);right:0;bottom:0;width:min(420px,92vw);
      background:rgba(17,19,26,.90);backdrop-filter:blur(10px);
      border-left:1px solid var(--line);box-shadow:var(--shadow);
      transform:translateX(102%);transition:transform .22s ease;z-index:1200;
      display:flex;flex-direction:column;
    }
    .panel.open{transform:translateX(0)}
    .panelHeader{padding:14px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:flex-start}
    .panelHeader h2{margin:0;font-size:16px;line-height:1.2}
    .sub{margin-top:6px;color:var(--muted);font-size:12px;line-height:1.35;word-break:break-word}
    .panelBody{padding:14px;overflow:auto;flex:1}
    .hint{font-size:12px;color:var(--muted);line-height:1.45}

    .section{margin-top:14px}
    .sectionTitle{margin:0 0 10px;font-size:12px;color:rgba(167,175,191,.9);text-transform:uppercase;letter-spacing:.2px}

    .card{background:rgba(23,26,35,.8);border:1px solid var(--line);border-radius:var(--r);padding:12px;margin-bottom:10px}
    .visitTop{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .badge{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.12);white-space:nowrap}
    .visitContent{margin-top:10px;white-space:pre-wrap;font-size:13px;line-height:1.55}

    label{display:block;font-size:12px;color:rgba(167,175,191,.95);margin:0 0 6px}
    input, textarea{
      width:100%;border:1px solid var(--line);background:rgba(23,26,35,.8);
      color:var(--text);border-radius:12px;padding:10px;outline:none;font-size:13px
    }
    textarea{min-height:120px;resize:vertical;line-height:1.55}
    .grid{display:grid;grid-template-columns:1fr 120px;gap:10px}
    .row{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:2000;display:none;align-items:center;justify-content:center;padding:16px}
    .overlay.open{display:flex}
    .modal{width:min(720px,96vw);background:rgba(17,19,26,.92);border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow);overflow:hidden}
    .modalHeader{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:10px}
    .modalHeader h3{margin:0;font-size:15px;flex:1}
    .modalBody{padding:16px}
    .results{margin-top:10px;display:flex;flex-direction:column;gap:8px}
    .resultItem{padding:12px;border:1px solid var(--line);border-radius:14px;background:rgba(23,26,35,.8);cursor:pointer}
    .resultItem:hover{border-color:rgba(122,162,255,.55)}
    .resultItem .t{font-weight:800;font-size:13px;margin-bottom:4px}
    .resultItem .s{font-size:12px;color:var(--muted);line-height:1.35}

    .toast{
      position:fixed;left:50%;transform:translateX(-50%);bottom:18px;z-index:3000;
      background:rgba(23,26,35,.9);border:1px solid var(--line);
      border-radius:999px;padding:10px 14px;box-shadow:var(--shadow);
      display:none;gap:10px;align-items:center
    }
    .toast.show{display:flex}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--accent)}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">ğŸœ Seoul Shared Eats</div>

    <div class="search" title="ê¸°ë¡ëœ ê°€ê²Œ ê²€ìƒ‰ (Enter)">
      <span style="opacity:.75">ğŸ”</span>
      <input id="q" placeholder="ê°€ê²Œ ê²€ìƒ‰ (Enter)" />
    </div>

    <button id="addBtn" class="primary">ì¶”ê°€í•˜ê¸°</button>
    <button id="authBtn">ë¡œê·¸ì¸</button>
  </div>

  <div id="map"></div>

  <aside id="panel" class="panel" aria-hidden="true">
    <div class="panelHeader">
      <div style="flex:1;min-width:0">
        <h2 id="placeName">ê°€ê²Œ ì„ íƒí•´ì¤˜</h2>
        <div class="sub" id="placeAddr">ë§ˆì»¤ ëˆ„ë¥´ë©´ ëœ¸</div>
        <div class="sub" id="placeMeta"></div>
      </div>
      <button id="closePanelBtn">ë‹«ê¸°</button>
    </div>

    <div class="panelBody">
      <div class="hint" id="panelHint">ë§ˆì»¤ í´ë¦­í•˜ë©´ ë°©ë¬¸ ê¸°ë¡ì´ ë³´ì—¬.</div>

      <div class="section">
        <h4 class="sectionTitle">ë°©ë¬¸ ê¸°ë¡</h4>
        <div id="visits"></div>
      </div>

      <div class="section" id="editor" style="display:none">
        <h4 class="sectionTitle">ë°©ë¬¸ê¸° ì“°ê¸°</h4>

        <div class="grid">
          <div>
            <label>ë°©ë¬¸ ë‚ ì§œ</label>
            <input id="visitDate" type="date" />
          </div>
          <div>
            <label>í‰ì  (0~5)</label>
            <input id="visitRating" type="number" min="0" max="5" step="0.5" placeholder="4.5" />
          </div>
        </div>

        <div style="margin-top:10px">
          <label>ë°©ë¬¸ê¸°</label>
          <textarea id="visitContent" placeholder="ë¬¸ì„œì²˜ëŸ¼ ê¸¸ê²Œ ì ì–´ë„ ë¨"></textarea>
        </div>

        <div class="row">
          <button id="saveVisitBtn" class="primary">ì €ì¥</button>
        </div>

        <div class="hint" style="margin-top:10px">
          ë°©ë¬¸ê¸°ëŠ” ëª¨ë“  ì‚¬ëŒì—ê²Œ ê³µê°œë¼. ì‘ì„±ì ì´ë©”ì¼ ë¼ë²¨ì´ ê°™ì´ í‘œì‹œë¨.
        </div>
      </div>

      <div class="section" id="loginHint" style="display:none">
        <div class="hint">ë¡œê·¸ì¸í•˜ë©´ ë°©ë¬¸ê¸°ë¥¼ ë‚¨ê¸¸ ìˆ˜ ìˆì–´.</div>
      </div>
    </div>
  </aside>

  <!-- Add overlay -->
  <div id="addOverlay" class="overlay" aria-hidden="true">
    <div class="modal">
      <div class="modalHeader">
        <h3>ìƒˆ ìŒì‹ì  ì¶”ê°€</h3>
        <button id="closeAddBtn">ë‹«ê¸°</button>
      </div>

      <div class="modalBody">
        <div class="grid" style="grid-template-columns:1fr 1fr">
          <div>
            <label>ê°€ê²Œ ì´ë¦„</label>
            <input id="newName" type="text" placeholder="ì˜ˆ: OOë¼ë©˜" />
          </div>
          <div>
            <label>ì£¼ì†Œ(ê²€ìƒ‰ì–´)</label>
            <input id="newAddr" type="text" placeholder="ì˜ˆ: ê°•ë‚¨ ë…¼í˜„ë¡œ30ê¸¸ 43 / ì—°ë‚¨ë™ ë¼ë©˜" />
          </div>
        </div>

        <div class="row" style="justify-content:flex-start;margin-top:10px">
          <button id="addrSearchBtn" class="primary">ì£¼ì†Œ ì°¾ê¸°</button>
          <span id="geoStatus" class="hint"></span>
        </div>

        <div class="hint" style="margin-top:8px">
          í›„ë³´ê°€ ì—¬ëŸ¬ ê°œë©´ í•˜ë‚˜ ê³¨ë¼. (ì„œìš¸ë§Œ ì €ì¥)
        </div>

        <div id="results" class="results"></div>
      </div>
    </div>
  </div>

  <!-- Auth overlay -->
  <div id="authOverlay" class="overlay" aria-hidden="true">
    <div class="modal" style="width:min(520px,96vw)">
      <div class="modalHeader">
        <h3>ë¡œê·¸ì¸ / íšŒì›ê°€ì…</h3>
        <button id="closeAuthBtn">ë‹«ê¸°</button>
      </div>

      <div class="modalBody">
        <div class="card">
          <label>ì´ë©”ì¼</label>
          <input id="email" type="email" placeholder="you@example.com" />
          <label>ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)</label>
          <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
          <div class="row">
            <button id="loginBtn" class="primary">ë¡œê·¸ì¸</button>
            <button id="signupBtn">íšŒì›ê°€ì…</button>
          </div>
          <div class="hint" style="margin-top:10px">
            íšŒì›ê°€ì…ì´ ì•ˆ ë˜ë©´ Supabaseì—ì„œ Email provider / Signups ì¼œì¡ŒëŠ”ì§€ë¶€í„° í™•ì¸.
          </div>
        </div>

        <div class="card" id="accountCard" style="display:none">
          <div class="hint">í˜„ì¬ ë¡œê·¸ì¸:</div>
          <div id="accountEmail" style="font-weight:800;margin-top:6px"></div>
          <div class="row">
            <button id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"><span class="dot"></span><span id="toastText">.</span></div>

  <script>
    /*********** ë„ˆê°€ êµì²´í•  ê°’ ***********/
    const SB_URL = "https://tqybsmrmzxnfuwypbazn.supabase.co";
    const SB_KEY = "sb_publishable_NOdwos9jU0jwL0AzvZrHHg_KSH5f2e1";
    /*************************************/

    const $ = (id) => document.getElementById(id);
    const esc = (s)=>String(s??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;");
    const todayISO = () => new Date().toISOString().slice(0,10);

    function toast(msg){
      $('toastText').textContent = msg;
      $('toast').classList.add('show');
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=> $('toast').classList.remove('show'), 2400);
    }

    function open(el){ el.classList.add('open'); el.setAttribute('aria-hidden','false'); }
    function close(el){ el.classList.remove('open'); el.setAttribute('aria-hidden','true'); }

    const state = {
      sbClient: null,
      user: null,
      map: null,
      geocoder: null,
      places: [],
      markers: new Map(),
      selectedPlace: null
    };

    function configured(){
      return SB_URL && SB_KEY && !SB_URL.includes("YOUR_") && !SB_KEY.includes("YOUR_");
    }

    async function initSupabase(){
      if(!configured()){ toast('Supabase URL/KEYë¥¼ index.htmlì— ë„£ì–´ì¤˜'); return; }
      if(!window.supabase?.createClient){ toast('Supabase SDK ë¡œë”© ì‹¤íŒ¨'); return; }

      state.sbClient = window.supabase.createClient(SB_URL, SB_KEY, {
        auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
      });

      const { data, error } = await state.sbClient.auth.getSession();
      if(error) console.error(error);
      state.user = data?.session?.user ?? null;
      updateAuthUI();

      state.sbClient.auth.onAuthStateChange((_event, session) => {
        state.user = session?.user ?? null;
        updateAuthUI();
        // ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ì§í›„ UI ê°±ì‹ 
        if(state.selectedPlace) loadVisitsAndRender(state.selectedPlace.id);
      });
    }

    function updateAuthUI(){
      const u = state.user;
      $('authBtn').textContent = u ? (u.email ?? 'ê³„ì •') : 'ë¡œê·¸ì¸';

      if(u){
        $('accountCard').style.display = 'block';
        $('accountEmail').textContent = u.email ?? '';
        $('editor').style.display = 'block';
        $('loginHint').style.display = 'none';
      } else {
        $('accountCard').style.display = 'none';
        $('editor').style.display = 'none';
        $('loginHint').style.display = 'block';
      }
    }

    function initMap(){
      if(!(window.kakao && window.kakao.maps)){
        toast('ì¹´ì¹´ì˜¤ ì§€ë„ SDK ë¡œë”© ì‹¤íŒ¨ (í‚¤/ë„ë©”ì¸/ì¹´ì¹´ì˜¤ë§µ ON í™•ì¸)');
        return;
      }
      const center = new kakao.maps.LatLng(37.5665, 126.9780);
      state.map = new kakao.maps.Map($('map'), { center, level: 6 });
      state.geocoder = new kakao.maps.services.Geocoder();
    }

    async function loadPlaces(){
      if(!state.sbClient){ return; }

      const { data, error } = await state.sbClient
        .from('places')
        .select('*')
        .order('created_at', { ascending: false });

      if(error){ console.error(error); toast('places ë¡œë”© ì‹¤íŒ¨'); return; }
      state.places = data ?? [];
      renderMarkers();
    }

    function clearMarkers(){
      for(const m of state.markers.values()) m.setMap(null);
      state.markers.clear();
    }

    function renderMarkers(){
      if(!state.map) return;

      clearMarkers();
      for(const p of state.places){
        const marker = new kakao.maps.Marker({
          position: new kakao.maps.LatLng(p.lat, p.lng)
        });
        marker.setMap(state.map);
        kakao.maps.event.addListener(marker, 'click', ()=> openPlace(p.id));
        state.markers.set(p.id, marker);
      }
    }

    function closePanel(){
      close($('panel'));
      state.selectedPlace = null;
      $('placeName').textContent = 'ê°€ê²Œ ì„ íƒí•´ì¤˜';
      $('placeAddr').textContent = 'ë§ˆì»¤ ëˆ„ë¥´ë©´ ëœ¸';
      $('placeMeta').textContent = '';
      $('visits').innerHTML = '';
      $('panelHint').textContent = 'ë§ˆì»¤ í´ë¦­í•˜ë©´ ë°©ë¬¸ ê¸°ë¡ì´ ë³´ì—¬.';
    }

    async function openPlace(placeId){
      const place = state.places.find(p => p.id === placeId);
      if(!place) return;
      state.selectedPlace = place;

      $('placeName').textContent = place.name;
      $('placeAddr').textContent = place.address;
      $('placeMeta').textContent = `ì¶”ê°€ì: ${place.user_id}`;
      $('panelHint').textContent = 'ë°©ë¬¸ê¸°ëŠ” ê³µê°œ. ë¡œê·¸ì¸í•˜ë©´ ì‘ì„± ê°€ëŠ¥.';
      $('visitDate').value = todayISO();
      $('visitRating').value = '';
      $('visitContent').value = '';

      open($('panel'));

      // ì§€ë„ ì´ë™
      const pos = new kakao.maps.LatLng(place.lat, place.lng);
      state.map.setCenter(pos);
      state.map.setLevel(Math.min(state.map.getLevel(), 4));

      await loadVisitsAndRender(place.id);
    }

    async function loadVisitsAndRender(placeId){
      if(!state.sbClient) return;

      const wrap = $('visits');
      wrap.innerHTML = '<div class="hint">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';

      const { data, error } = await state.sbClient
        .from('visits')
        .select('*')
        .eq('place_id', placeId)
        .order('visited_at', { ascending: false })
        .order('created_at', { ascending: false });

      if(error){ console.error(error); toast('visits ë¡œë”© ì‹¤íŒ¨'); wrap.innerHTML=''; return; }

      const items = data ?? [];
      if(items.length === 0){
        wrap.innerHTML = '<div class="hint">ì•„ì§ ë°©ë¬¸ ê¸°ë¡ ì—†ìŒ.</div>';
        return;
      }

      wrap.innerHTML = '';
      for(const v of items){
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <div class="visitTop">
            <div style="font-weight:800">${esc(v.visited_at)}</div>
            <div class="badge">${v.rating == null ? 'í‰ì  ì—†ìŒ' : ('í‰ì  ' + esc(v.rating))}</div>
          </div>
          <div class="sub" style="margin-top:6px">ì‘ì„±ì: ${esc(v.author_email)}</div>
          <div class="visitContent">${esc(v.content || '')}</div>
        `;
        wrap.appendChild(div);
      }
    }

    function isSeoulByCoord(lat, lng){
      return new Promise((resolve) => {
        state.geocoder.coord2RegionCode(lng, lat, (res, status) => {
          if(status !== kakao.maps.services.Status.OK || !res || res.length === 0){
            resolve(true);
            return;
          }
          const any = res.find(x => x.region_1depth_name) || res[0];
          resolve((any.region_1depth_name || '').includes('ì„œìš¸'));
        });
      });
    }

    async function createPlace({ name, address, lat, lng }){
      const u = state.user;
      if(!u){ toast('ê°€ê²Œ ì¶”ê°€ëŠ” ë¡œê·¸ì¸ í•„ìš”'); return null; }

      const payload = {
        user_id: u.id,
        name,
        address,
        lat,
        lng
      };

      const { data, error } = await state.sbClient
        .from('places')
        .insert(payload)
        .select('*')
        .single();

      if(error){ console.error(error); toast(error.message || 'ê°€ê²Œ ì €ì¥ ì‹¤íŒ¨'); return null; }
      return data;
    }

    async function saveVisit(){
      const u = state.user;
      if(!u){ toast('ë¡œê·¸ì¸ í•„ìš”'); return; }
      if(!state.selectedPlace){ toast('ê°€ê²Œë¶€í„° ì„ íƒ'); return; }

      const visited_at = $('visitDate').value || todayISO();
      const ratingRaw = $('visitRating').value;
      const rating = (ratingRaw === '') ? null : Math.max(0, Math.min(5, Number(ratingRaw)));
      const content = ($('visitContent').value || '').trim();

      if(!content){ toast('ë°©ë¬¸ê¸° ë‚´ìš©ì„ ì¨ì¤˜'); return; }

      $('saveVisitBtn').disabled = true;
      try{
        const payload = {
          user_id: u.id,
          author_email: u.email || 'unknown',
          place_id: state.selectedPlace.id,
          visited_at,
          rating,
          content
        };

        const { error } = await state.sbClient.from('visits').insert(payload);
        if(error){ console.error(error); toast(error.message || 'ì €ì¥ ì‹¤íŒ¨'); return; }

        $('visitContent').value = '';
        $('visitRating').value = '';
        toast('ì €ì¥ë¨');
        await loadVisitsAndRender(state.selectedPlace.id);
      } finally {
        $('saveVisitBtn').disabled = false;
      }
    }

    // ===== ì´ë²¤íŠ¸ ë°”ì¸ë”© =====
    window.addEventListener('DOMContentLoaded', () => {
      $('visitDate').value = todayISO();

      $('addBtn').addEventListener('click', () => {
        if(!state.user) toast('ì¶”ê°€ëŠ” ë¡œê·¸ì¸ í•„ìš” (ì½ê¸°ëŠ” ê³µê°œ)');
        open($('addOverlay'));
      });
      $('closeAddBtn').addEventListener('click', ()=> close($('addOverlay')));

      $('authBtn').addEventListener('click', ()=> open($('authOverlay')));
      $('closeAuthBtn').addEventListener('click', ()=> close($('authOverlay')));

      $('closePanelBtn').addEventListener('click', closePanel);
      $('saveVisitBtn').addEventListener('click', saveVisit);

      $('loginBtn').addEventListener('click', async () => {
        const email = ($('email').value || '').trim();
        const password = $('password').value || '';
        if(!email || !password){ toast('ì´ë©”ì¼/ë¹„ë²ˆ ì…ë ¥'); return; }

        $('loginBtn').disabled = true;
        try{
          const { error } = await state.sbClient.auth.signInWithPassword({ email, password });
          if(error){ console.error(error); toast(error.message || 'ë¡œê·¸ì¸ ì‹¤íŒ¨'); return; }
          toast('ë¡œê·¸ì¸ ë¨');
          close($('authOverlay'));
        } finally {
          $('loginBtn').disabled = false;
        }
      });

      $('signupBtn').addEventListener('click', async () => {
        const email = ($('email').value || '').trim();
        const password = $('password').value || '';
        if(!email || !password){ toast('ì´ë©”ì¼/ë¹„ë²ˆ ì…ë ¥'); return; }

        $('signupBtn').disabled = true;
        try{
          const { error } = await state.sbClient.auth.signUp({ email, password });
          if(error){ console.error(error); toast(error.message || 'íšŒì›ê°€ì… ì‹¤íŒ¨'); return; }
          toast('íšŒì›ê°€ì… ì™„ë£Œ (ì´ë©”ì¼ ì¸ì¦ì´ ì¼œì ¸ ìˆìœ¼ë©´ ë©”ì¼ í™•ì¸)');
        } finally {
          $('signupBtn').disabled = false;
        }
      });

      $('logoutBtn').addEventListener('click', async () => {
        await state.sbClient.auth.signOut();
        toast('ë¡œê·¸ì•„ì›ƒ');
      });

      $('addrSearchBtn').addEventListener('click', () => {
        if(!state.geocoder){ toast('ì§€ë„ ì¤€ë¹„ ì•ˆ ë¨'); return; }

        const name = ($('newName').value || '').trim();
        const q = ($('newAddr').value || '').trim();
        if(!name){ toast('ê°€ê²Œ ì´ë¦„ë¶€í„°'); return; }
        if(!q){ toast('ì£¼ì†Œ(ê²€ìƒ‰ì–´)ë¶€í„°'); return; }

        $('geoStatus').textContent = 'ì°¾ëŠ” ì¤‘â€¦';
        $('results').innerHTML = '';

        state.geocoder.addressSearch(q, (result, status) => {
          if(status !== kakao.maps.services.Status.OK || !result || result.length === 0){
            $('geoStatus').textContent = 'ê²°ê³¼ ì—†ìŒ';
            return;
          }

          $('geoStatus').textContent = `í›„ë³´ ${result.length}ê°œ`;

          for(const r of result){
            const lat = Number(r.y);
            const lng = Number(r.x);
            const addr = r.address_name || q;

            const item = document.createElement('div');
            item.className = 'resultItem';
            item.innerHTML = `
              <div class="t">${esc(name)}</div>
              <div class="s">${esc(addr)}</div>
              <div class="s">ì¢Œí‘œ: ${lat.toFixed(5)}, ${lng.toFixed(5)}</div>
            `;

            item.addEventListener('click', async () => {
              const ok = await isSeoulByCoord(lat, lng);
              if(!ok){ toast('ì„œìš¸ì´ ì•„ë‹ˆë©´ ì €ì¥ ì•ˆ í•¨'); return; }

              const created = await createPlace({ name, address: addr, lat, lng });
              if(!created) return;

              close($('addOverlay'));
              $('newName').value = '';
              $('newAddr').value = '';
              $('results').innerHTML = '';
              $('geoStatus').textContent = '';

              toast('ê°€ê²Œ ì¶”ê°€ë¨');
              await loadPlaces();
              await openPlace(created.id);
            });

            $('results').appendChild(item);
          }
        });
      });

      $('q').addEventListener('keydown', (e) => {
        if(e.key !== 'Enter') return;
        const q = ($('q').value || '').trim().toLowerCase();
        if(!q) return;

        const hit = state.places.find(p =>
          (p.name || '').toLowerCase().includes(q) ||
          (p.address || '').toLowerCase().includes(q)
        );

        if(!hit){ toast('ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ'); return; }
        openPlace(hit.id);
      });
    });

    // ===== ë¶€íŒ… =====
    window.addEventListener('load', async () => {
      initMap();
      await initSupabase();
      await loadPlaces();
    });
  </script>
</body>
</html>
