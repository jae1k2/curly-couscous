<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì„œìš¸ ìŒì‹ì  ì§€ë„</title>

  <!-- Kakao Maps SDK -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=5c2fb05e6765f133c747e1f5a2bdf64d&libraries=services"></script>

  <!-- Supabase SDK (ì „ì—­ì— window.supabase ì œê³µ) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0b0c10; --panel:#11131a; --card:#171a23;
      --text:#e9ecf1; --muted:#a7afbf; --line:#242a36;
      --accent:#7aa2ff; --shadow:0 10px 30px rgba(0,0,0,.35);
      --r:16px; --top:56px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:var(--bg);color:var(--text)}
    .topbar{
      position:fixed;left:0;right:0;top:0;height:var(--top);
      display:flex;align-items:center;gap:10px;padding:10px 12px;
      border-bottom:1px solid var(--line);
      background:rgba(11,12,16,.85);backdrop-filter:blur(10px);z-index:1000;
    }
    .brand{font-weight:800;letter-spacing:.2px;white-space:nowrap}
    .search{flex:1;max-width:760px;display:flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;border:1px solid var(--line);background:rgba(23,26,35,.75)}
    .search input{width:100%;border:0;outline:0;background:transparent;color:var(--text);font-size:14px}
    .search input::placeholder{color:rgba(167,175,191,.7)}
    button{
      border:1px solid var(--line);background:rgba(23,26,35,.75);color:var(--text);
      padding:10px 12px;border-radius:999px;cursor:pointer
    }
    button.primary{background:rgba(122,162,255,.16);border-color:rgba(122,162,255,.45)}
    button:disabled{opacity:.55;cursor:not-allowed}
    #map{position:fixed;left:0;right:0;top:var(--top);bottom:0}

    .panel{
      position:fixed;top:var(--top);right:0;bottom:0;width:min(420px,92vw);
      background:rgba(17,19,26,.90);backdrop-filter:blur(10px);
      border-left:1px solid var(--line);box-shadow:var(--shadow);
      transform:translateX(102%);transition:transform .22s ease;z-index:1200;
      display:flex;flex-direction:column;
    }
    .panel.open{transform:translateX(0)}
    .panelHeader{padding:14px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:flex-start}
    .panelHeader h2{margin:0;font-size:16px;line-height:1.2}
    .sub{margin-top:6px;color:var(--muted);font-size:12px;line-height:1.35;word-break:break-word}
    .panelBody{padding:14px;overflow:auto;flex:1}
    .hint{font-size:12px;color:var(--muted);line-height:1.45}
    .section{margin-top:14px}
    .sectionTitle{margin:0 0 10px;font-size:12px;color:rgba(167,175,191,.9);text-transform:uppercase;letter-spacing:.2px}

    .card{background:rgba(23,26,35,.8);border:1px solid var(--line);border-radius:var(--r);padding:12px;margin-bottom:10px}
    .visitTop{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .badge{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.12)}
    .visitContent{margin-top:10px;white-space:pre-wrap;font-size:13px;line-height:1.55}

    label{display:block;font-size:12px;color:rgba(167,175,191,.95);margin:0 0 6px}
    input, textarea{
      width:100%;border:1px solid var(--line);background:rgba(23,26,35,.8);
      color:var(--text);border-radius:12px;padding:10px;outline:none;font-size:13px
    }
    textarea{min-height:120px;resize:vertical;line-height:1.55}
    .grid{display:grid;grid-template-columns:1fr 120px;gap:10px}
    .row{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:2000;display:none;align-items:center;justify-content:center;padding:16px}
    .overlay.open{display:flex}
    .modal{width:min(720px,96vw);background:rgba(17,19,26,.92);border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow);overflow:hidden}
    .modalHeader{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:10px}
    .modalHeader h3{margin:0;font-size:15px;flex:1}
    .modalBody{padding:16px}
    .results{margin-top:10px;display:flex;flex-direction:column;gap:8px}
    .resultItem{padding:12px;border:1px solid var(--line);border-radius:14px;background:rgba(23,26,35,.8);cursor:pointer}
    .resultItem:hover{border-color:rgba(122,162,255,.55)}
    .resultItem .t{font-weight:800;font-size:13px;margin-bottom:4px}
    .resultItem .s{font-size:12px;color:var(--muted);line-height:1.35}

    .toast{
      position:fixed;left:50%;transform:translateX(-50%);bottom:18px;z-index:3000;
      background:rgba(23,26,35,.9);border:1px solid var(--line);
      border-radius:999px;padding:10px 14px;box-shadow:var(--shadow);
      display:none;gap:10px;align-items:center
    }
    .toast.show{display:flex}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--accent)}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">ğŸœ Seoul Eats</div>
    <div class="search" title="ê¸°ë¡ëœ ê°€ê²Œ ê²€ìƒ‰ (Enter)">
      <span style="opacity:.75">ğŸ”</span>
      <input id="q" placeholder="ê¸°ë¡ëœ ê°€ê²Œ ê²€ìƒ‰ (Enter)" />
    </div>
    <button id="addBtn" class="primary">ì¶”ê°€í•˜ê¸°</button>
    <button id="authBtn">ë¡œê·¸ì¸</button>
  </div>

  <div id="map"></div>

  <aside id="panel" class="panel" aria-hidden="true">
    <div class="panelHeader">
      <div style="flex:1;min-width:0">
        <h2 id="placeName">ê°€ê²Œ ì„ íƒí•´ì¤˜</h2>
        <div class="sub" id="placeAddr">ë§ˆì»¤ ëˆ„ë¥´ë©´ ëœ¸</div>
      </div>
      <button id="closePanelBtn">ë‹«ê¸°</button>
    </div>
    <div class="panelBody">
      <div class="hint" id="panelHint">ë§ˆì»¤ í´ë¦­í•˜ë©´ ë°©ë¬¸ê¸° ì“°ëŠ” ì¹¸ì´ ìƒê²¨.</div>

      <div class="section">
        <h4 class="sectionTitle">ë°©ë¬¸ ê¸°ë¡</h4>
        <div id="visits"></div>
      </div>

      <div class="section" id="editor" style="display:none">
        <h4 class="sectionTitle">ë°©ë¬¸ê¸° ì“°ê¸°</h4>
        <div class="grid">
          <div>
            <label>ë°©ë¬¸ ë‚ ì§œ</label>
            <input id="visitDate" type="date" />
          </div>
          <div>
            <label>í‰ì  (0~5)</label>
            <input id="visitRating" type="number" min="0" max="5" step="0.5" placeholder="4.5" />
          </div>
        </div>
        <div style="margin-top:10px">
          <label>ë°©ë¬¸ê¸° (ë¬¸ì„œì²˜ëŸ¼ ê¸¸ê²Œ)</label>
          <textarea id="visitContent" placeholder="ì˜¤ëŠ˜ì€ êµ­ë¬¼ ë†ë„ëŠ” ê°€ë²¼ì› ëŠ”ë°â€¦"></textarea>
        </div>
        <div class="row">
          <button id="saveVisitBtn" class="primary">ì €ì¥</button>
        </div>
      </div>
    </div>
  </aside>

  <!-- Add overlay -->
  <div id="addOverlay" class="overlay" aria-hidden="true">
    <div class="modal">
      <div class="modalHeader">
        <h3>ìƒˆ ìŒì‹ì  ì¶”ê°€</h3>
        <button id="closeAddBtn">ë‹«ê¸°</button>
      </div>
      <div class="modalBody">
        <div class="grid" style="grid-template-columns:1fr 1fr">
          <div>
            <label>ê°€ê²Œ ì´ë¦„</label>
            <input id="newName" type="text" placeholder="ì˜ˆ: OOë¼ë©˜" />
          </div>
          <div>
            <label>ì£¼ì†Œ(ê²€ìƒ‰ì–´)</label>
            <input id="newAddr" type="text" placeholder="ì˜ˆ: ì—°ë‚¨ë™ ë¼ë©˜ / ë„ë¡œëª… ì£¼ì†Œ" />
          </div>
        </div>
        <div class="row" style="justify-content:flex-start;margin-top:10px">
          <button id="addrSearchBtn" class="primary">ì£¼ì†Œ ì°¾ê¸°</button>
          <span id="geoStatus" class="hint"></span>
        </div>
        <div class="hint" style="margin-top:8px">
          í›„ë³´ê°€ ì—¬ëŸ¬ ê°œë©´ í•˜ë‚˜ ê³¨ë¼. ì„ íƒí•˜ë©´ ë§ˆì»¤ê°€ ìƒê¸°ê³ , ê·¸ ê°€ê²Œë¡œ ë°”ë¡œ ì´ë™í•´.
        </div>
        <div id="results" class="results"></div>
      </div>
    </div>
  </div>

  <!-- Auth overlay -->
  <div id="authOverlay" class="overlay" aria-hidden="true">
    <div class="modal" style="width:min(520px,96vw)">
      <div class="modalHeader">
        <h3>ë¡œê·¸ì¸ (ì´ë©”ì¼ ë§¤ì§ë§í¬)</h3>
        <button id="closeAuthBtn">ë‹«ê¸°</button>
      </div>
      <div class="modalBody">
        <div class="card">
          <label>ì´ë©”ì¼</label>
          <input id="email" type="email" placeholder="you@example.com" />
          <div class="row">
            <button id="sendLinkBtn" class="primary">ë¡œê·¸ì¸ ë§í¬ ë³´ë‚´ê¸°</button>
          </div>
          <div class="hint">ë©”ì¼ë¡œ ì˜¨ ë§í¬ ëˆ„ë¥´ë©´ ë¡œê·¸ì¸ ì™„ë£Œë˜ê³ , ì´ ê¸°ê¸°ì—ë„ ì„¸ì…˜ì´ ë‚¨ì•„.</div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"><span class="dot"></span><span id="toastText">.</span></div>

  <script>
    /*********** í‚¤ 2ê°œë§Œ ì—¬ê¸° êµì²´ ***********/
    const SUPABASE_URL = "https://tqybsmrmzxnfuwypbazn.supabase.co";
    const SUPABASE_PUBLISHABLE_KEY = "sb_publishable_NOdwos9jU0jwL0AzvZrHHg_KSH5f2e1";
    /*****************************************/

    const $ = (id) => document.getElementById(id);
    const esc = (s)=>String(s??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;");
    const todayISO = () => new Date().toISOString().slice(0,10);

    const toast = (msg) => {
      const t = $('toast');
      $('toastText').textContent = msg;
      t.classList.add('show');
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=>t.classList.remove('show'), 2200);
    };

    const open = (el)=>{ el.classList.add('open'); el.setAttribute('aria-hidden','false'); };
    const close = (el)=>{ el.classList.remove('open'); el.setAttribute('aria-hidden','true'); };

    // âœ… ì ˆëŒ€ `supabase`ë¼ëŠ” ë³€ìˆ˜ëª… ì•ˆ ì”€
    let sbClient = null;
    let sbUser = null;

    let map = null;
    let geocoder = null;

    let places = [];
    const markers = new Map();
    let selectedPlace = null;

    function supabaseConfigured(){
      return SUPABASE_URL && SUPABASE_PUBLISHABLE_KEY &&
        !SUPABASE_URL.includes("YOUR_") && !SUPABASE_PUBLISHABLE_KEY.includes("YOUR_");
    }

    function openPanel(){ open($('panel')); }
    function closePanel(){
      close($('panel'));
      selectedPlace = null;
      $('placeName').textContent = 'ê°€ê²Œ ì„ íƒí•´ì¤˜';
      $('placeAddr').textContent = 'ë§ˆì»¤ ëˆ„ë¥´ë©´ ëœ¸';
      $('visits').innerHTML = '';
      $('editor').style.display = 'none';
      $('panelHint').textContent = 'ë§ˆì»¤ í´ë¦­í•˜ë©´ ë°©ë¬¸ê¸° ì“°ëŠ” ì¹¸ì´ ìƒê²¨.';
    }

    async function initSupabase(){
      if(!supabaseConfigured()){
        toast('Supabase URL/KEYë¶€í„° ë„£ì–´ì¤˜');
        return;
      }
      if(!window.supabase?.createClient){
        toast('Supabase SDK ë¡œë”© ì‹¤íŒ¨');
        return;
      }
      sbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);

      const { data } = await sbClient.auth.getSession();
      sbUser = data.session?.user ?? null;
      $('authBtn').textContent = sbUser ? 'ê³„ì •' : 'ë¡œê·¸ì¸';

      sbClient.auth.onAuthStateChange(async (_event, session) => {
        sbUser = session?.user ?? null;
        $('authBtn').textContent = sbUser ? 'ê³„ì •' : 'ë¡œê·¸ì¸';
        await loadPlacesAndRender();
        if(!sbUser) closePanel();
      });
    }

    function initMap(){
      if(!(window.kakao && window.kakao.maps)){
        toast('ì¹´ì¹´ì˜¤ ì§€ë„ SDK ë¡œë”© ì‹¤íŒ¨ (ë„ë©”ì¸ ë“±ë¡/í‚¤ í™•ì¸)');
        return;
      }
      const center = new kakao.maps.LatLng(37.5665, 126.9780);
      map = new kakao.maps.Map($('map'), { center, level: 6 });
      geocoder = new kakao.maps.services.Geocoder();
    }

    async function loadPlacesAndRender(){
      if(!sbClient || !sbUser){
        places = [];
        for(const m of markers.values()) m.setMap(null);
        markers.clear();
        return;
      }
      const { data, error } = await sbClient
        .from('places')
        .select('*')
        .order('created_at', { ascending:false });

      if(error){ console.error(error); toast('places ë¡œë”© ì‹¤íŒ¨'); return; }
      places = data ?? [];
      renderMarkers();
    }

    function renderMarkers(){
      for(const [id, m] of markers.entries()){
        if(!places.find(p => p.id === id)){
          m.setMap(null);
          markers.delete(id);
        }
      }
      for(const p of places){
        if(markers.has(p.id)) continue;
        const pos = new kakao.maps.LatLng(p.lat, p.lng);
        const marker = new kakao.maps.Marker({ position: pos });
        marker.setMap(map);
        kakao.maps.event.addListener(marker, 'click', ()=> openPlace(p.id));
        markers.set(p.id, marker);
      }
    }

    async function openPlace(placeId){
      const place = places.find(p => p.id === placeId);
      if(!place) return;

      selectedPlace = place;
      $('placeName').textContent = place.name;
      $('placeAddr').textContent = place.address;
      $('panelHint').textContent = 'ì•„ë˜ì—ì„œ ë°©ë¬¸ê¸° ì“°ê³  ì €ì¥í•˜ë©´ ì¹´ë“œë¡œ ìŒ“ì—¬.';
      $('editor').style.display = 'block';

      $('visitDate').value = todayISO();
      $('visitRating').value = '';
      $('visitContent').value = '';

      openPanel();

      const pos = new kakao.maps.LatLng(place.lat, place.lng);
      map.setCenter(pos);
      map.setLevel(Math.min(map.getLevel(), 4));

      await loadVisitsAndRender(place.id);
    }

    async function loadVisitsAndRender(placeId){
      const wrap = $('visits');
      wrap.innerHTML = '<div class="hint">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';

      const { data, error } = await sbClient
        .from('visits')
        .select('*')
        .eq('place_id', placeId)
        .order('visited_at', { ascending:false })
        .order('created_at', { ascending:false });

      if(error){ console.error(error); toast('visits ë¡œë”© ì‹¤íŒ¨'); wrap.innerHTML=''; return; }

      const items = data ?? [];
      if(items.length === 0){
        wrap.innerHTML = '<div class="hint">ì•„ì§ ë°©ë¬¸ ê¸°ë¡ ì—†ìŒ. ì•„ë˜ì—ì„œ í•˜ë‚˜ ì¨.</div>';
        return;
      }
      wrap.innerHTML = '';
      for(const v of items){
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <div class="visitTop">
            <div style="font-weight:800">${esc(v.visited_at)}</div>
            <div class="badge">${v.rating == null ? 'í‰ì  ì—†ìŒ' : 'í‰ì  ' + esc(v.rating)}</div>
          </div>
          <div class="visitContent">${esc(v.content || '')}</div>
        `;
        wrap.appendChild(div);
      }
    }

    async function checkSeoul(lat, lng){
      return new Promise((resolve) => {
        geocoder.coord2RegionCode(lng, lat, (res, status) => {
          if(status !== kakao.maps.services.Status.OK || !res || res.length === 0){
            resolve(true);
            return;
          }
          const any = res.find(x => x.region_1depth_name) || res[0];
          resolve((any.region_1depth_name || '').includes('ì„œìš¸'));
        });
      });
    }

    async function createPlace({ name, address, lat, lng }){
      const payload = { user_id: sbUser.id, name, address, lat, lng };
      const { data, error } = await sbClient
        .from('places')
        .insert(payload)
        .select('*')
        .single();

      if(error){ console.error(error); toast('ê°€ê²Œ ì €ì¥ ì‹¤íŒ¨'); throw error; }
      return data;
    }

    window.addEventListener('DOMContentLoaded', () => {
      $('visitDate').value = todayISO();

      $('addBtn').addEventListener('click', ()=> open($('addOverlay')));
      $('closeAddBtn').addEventListener('click', ()=> close($('addOverlay')));
      $('authBtn').addEventListener('click', ()=> open($('authOverlay')));
      $('closeAuthBtn').addEventListener('click', ()=> close($('authOverlay')));
      $('closePanelBtn').addEventListener('click', closePanel);

      $('sendLinkBtn').addEventListener('click', async () => {
        if(!sbClient){ toast('Supabase ì„¤ì •ë¶€í„°'); return; }
        const email = ($('email').value || '').trim();
        if(!email){ toast('ì´ë©”ì¼ ì¨ì¤˜'); return; }

        $('sendLinkBtn').disabled = true;
        try{
          const redirect = window.location.origin + window.location.pathname;
          const { error } = await sbClient.auth.signInWithOtp({
            email,
            options: { emailRedirectTo: redirect }
          });
          if(error){ console.error(error); toast('ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨'); return; }
          toast('ë¡œê·¸ì¸ ë§í¬ ë³´ëƒ„');
        } finally {
          $('sendLinkBtn').disabled = false;
        }
      });

      $('addrSearchBtn').addEventListener('click', () => {
        if(!geocoder){ toast('ì§€ë„ ì¤€ë¹„ ì•ˆ ë¨'); return; }
        if(!sbClient || !sbUser){ toast('ë¡œê·¸ì¸ë¶€í„°'); return; }

        const name = ($('newName').value || '').trim();
        const q = ($('newAddr').value || '').trim();
        if(!q){ toast('ì£¼ì†Œ(ê²€ìƒ‰ì–´) ë„£ì–´ì¤˜'); return; }

        $('geoStatus').textContent = 'ì°¾ëŠ” ì¤‘â€¦';
        $('results').innerHTML = '';

        geocoder.addressSearch(q, (result, status) => {
          if(status !== kakao.maps.services.Status.OK || !result || result.length === 0){
            $('geoStatus').textContent = 'ê²°ê³¼ ì—†ìŒ';
            return;
          }
          $('geoStatus').textContent = `í›„ë³´ ${result.length}ê°œ`;

          for(const r of result){
            const lat = Number(r.y);
            const lng = Number(r.x);
            const addr = r.address_name || q;

            const item = document.createElement('div');
            item.className = 'resultItem';
            item.innerHTML = `
              <div class="t">${esc(name || 'ì´ë¦„ ë¯¸ì •')}</div>
              <div class="s">${esc(addr)}</div>
              <div class="s">ì¢Œí‘œ: ${lat.toFixed(5)}, ${lng.toFixed(5)}</div>
            `;

            item.addEventListener('click', async () => {
              const ok = await checkSeoul(lat, lng);
              if(!ok){ toast('ì„œìš¸ ì•„ë‹ˆë©´ ì €ì¥ ë§‰ì„ê²Œ'); return; }

              const place = await createPlace({
                name: name || 'ì´ë¦„ ë¯¸ì •',
                address: addr,
                lat, lng
              });

              close($('addOverlay'));
              $('newName').value = '';
              $('newAddr').value = '';
              $('results').innerHTML = '';
              $('geoStatus').textContent = '';

              toast('ê°€ê²Œ ì¶”ê°€ë¨');
              await loadPlacesAndRender();
              await openPlace(place.id);
            });

            $('results').appendChild(item);
          }
        });
      });

      $('saveVisitBtn').addEventListener('click', async () => {
        if(!sbClient || !sbUser){ toast('ë¡œê·¸ì¸ë¶€í„°'); return; }
        if(!selectedPlace){ toast('ê°€ê²Œë¶€í„° ì„ íƒ'); return; }

        const visited_at = $('visitDate').value || todayISO();
        const ratingRaw = $('visitRating').value;
        const rating = (ratingRaw === '') ? null : Math.max(0, Math.min(5, Number(ratingRaw)));
        const content = ($('visitContent').value || '').trim();
        if(!content){ toast('ë°©ë¬¸ê¸° ë‚´ìš©ì€ ì¨ì¤˜'); return; }

        $('saveVisitBtn').disabled = true;
        try{
          const payload = {
            user_id: sbUser.id,
            place_id: selectedPlace.id,
            visited_at,
            rating,
            content
          };
          const { error } = await sbClient.from('visits').insert(payload);
          if(error){ console.error(error); toast('ì €ì¥ ì‹¤íŒ¨'); return; }

          $('visitContent').value = '';
          $('visitRating').value = '';
          toast('ì €ì¥ë¨');
          await loadVisitsAndRender(selectedPlace.id);
        } finally {
          $('saveVisitBtn').disabled = false;
        }
      });

      $('q').addEventListener('keydown', (e) => {
        if(e.key !== 'Enter') return;
        const q = ($('q').value || '').trim().toLowerCase();
        if(!q) return;

        const hit = places.find(p =>
          (p.name || '').toLowerCase().includes(q) ||
          (p.address || '').toLowerCase().includes(q)
        );
        if(!hit){ toast('ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ'); return; }
        openPlace(hit.id);
      });
    });

    window.addEventListener('load', async () => {
      initMap();
      await initSupabase();
      await loadPlacesAndRender();
    });
  </script>
</body>
</html>
