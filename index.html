<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Seoul Shared Eats</title>

  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=5c2fb05e6765f133c747e1f5a2bdf64d&libraries=services"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0b0c10;
      --card:rgba(20,22,30,.72);
      --card2:rgba(24,27,37,.78);
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.14);
      --text:#e9ecf1;
      --muted:rgba(233,236,241,.65);
      --accent:#9bb7ff;
      --shadow:0 18px 50px rgba(0,0,0,.45);
      --r:18px;
      --pill:999px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:var(--bg);color:var(--text)}
    #map{position:fixed;inset:0}

    /* floating dock (ì£¼ê°„ë³´ë“œ ëŠë‚Œ) */
    .dock{
      position:fixed;
      left:14px; right:14px; top:12px;
      display:flex; gap:10px; align-items:center;
      padding:10px 12px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      backdrop-filter:blur(12px);
      z-index:1000;
    }
    .brand{font-weight:900; letter-spacing:.2px; white-space:nowrap; opacity:.95}
    .search{
      flex:1; max-width:820px;
      display:flex; gap:8px; align-items:center;
      padding:10px 12px;
      border-radius:var(--pill);
      border:1px solid var(--line);
      background:rgba(0,0,0,.12);
    }
    .search input{
      width:100%; border:0; outline:0; background:transparent;
      color:var(--text); font-size:14px;
    }
    .search input::placeholder{color:rgba(233,236,241,.42)}
    button{
      border:1px solid var(--line);
      background:rgba(0,0,0,.14);
      color:var(--text);
      padding:10px 12px;
      border-radius:var(--pill);
      cursor:pointer;
    }
    button.primary{
      background:rgba(155,183,255,.16);
      border-color:rgba(155,183,255,.42);
    }
    button:disabled{opacity:.55; cursor:not-allowed}

    /* floating cards */
    .float{
      position:fixed;
      background:var(--card2);
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      backdrop-filter:blur(12px);
      z-index:1200;
      overflow:hidden;
    }
    .floatHeader{
      display:flex; gap:10px; align-items:flex-start;
      padding:14px 14px 12px;
      border-bottom:1px solid var(--line);
    }
    .floatHeader h3{
      margin:0; font-size:15px; line-height:1.25;
      font-weight:900;
    }
    .sub{margin-top:6px; color:var(--muted); font-size:12px; line-height:1.35; word-break:break-word}
    .floatBody{padding:14px; max-height:70vh; overflow:auto}

    .hint{font-size:12px; color:var(--muted); line-height:1.45}
    .section{margin-top:14px}
    .sectionTitle{
      margin:0 0 10px;
      font-size:12px;
      color:rgba(233,236,241,.62);
      text-transform:uppercase;
      letter-spacing:.25px;
    }

    .card{
      background:rgba(0,0,0,.14);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      margin-bottom:10px;
    }
    .visitTop{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .badge{
      font-size:12px; padding:6px 10px;
      border-radius:var(--pill);
      border:1px solid var(--line);
      background:rgba(0,0,0,.10);
      white-space:nowrap;
    }
    .visitContent{margin-top:10px; white-space:pre-wrap; font-size:13px; line-height:1.55}
    .miniActions{display:flex; gap:8px; margin-top:10px; justify-content:flex-end}
    .miniActions button{padding:8px 10px}

    label{display:block; font-size:12px; color:rgba(233,236,241,.70); margin:0 0 6px}
    input, textarea{
      width:100%;
      border:1px solid var(--line);
      background:rgba(0,0,0,.16);
      color:var(--text);
      border-radius:14px;
      padding:10px;
      outline:none;
      font-size:13px;
    }
    textarea{min-height:120px; resize:vertical; line-height:1.55}
    .grid{display:grid; grid-template-columns:1fr 120px; gap:10px}
    .row{display:flex; gap:8px; justify-content:flex-end; margin-top:10px}

    /* overlays: dim + floating modal */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.35);
      display:none; align-items:center; justify-content:center;
      padding:16px;
      z-index:2000;
    }
    .overlay.open{display:flex}
    .modal{
      width:min(720px,96vw);
      background:var(--card2);
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      backdrop-filter:blur(14px);
      overflow:hidden;
    }
    .modalHeader{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; gap:10px;
    }
    .modalHeader h3{margin:0; font-size:15px; flex:1; font-weight:900}
    .modalBody{padding:16px}

    .results{margin-top:10px; display:flex; flex-direction:column; gap:8px}
    .resultItem{
      padding:12px;
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(0,0,0,.14);
      cursor:pointer;
    }
    .resultItem:hover{border-color:rgba(155,183,255,.48)}
    .resultItem .t{font-weight:900; font-size:13px; margin-bottom:4px}
    .resultItem .s{font-size:12px; color:var(--muted); line-height:1.35}

    .statGrid{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px}
    .stat{
      background:rgba(0,0,0,.14);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
    }
    .stat .k{font-size:12px; color:var(--muted)}
    .stat .v{font-size:18px; font-weight:1000; margin-top:6px}

    /* toast */
    .toast{
      position:fixed;
      left:50%; transform:translateX(-50%);
      bottom:18px;
      background:rgba(18,20,28,.88);
      border:1px solid var(--line);
      border-radius:var(--pill);
      padding:10px 14px;
      box-shadow:var(--shadow);
      display:none; gap:10px; align-items:center;
      z-index:3000;
      backdrop-filter:blur(12px);
    }
    .toast.show{display:flex}
    .dot{width:8px; height:8px; border-radius:50%; background:var(--accent)}
  </style>
</head>

<body>
  <div id="map"></div>

  <!-- floating dock -->
  <div class="dock">
    <div class="brand">ğŸœ Shared Eats</div>

    <div class="search" title="ê°€ê²Œ ê²€ìƒ‰ (Enter)">
      <span style="opacity:.75">ğŸ”</span>
      <input id="q" placeholder="ê°€ê²Œ/ì£¼ì†Œ ê²€ìƒ‰ (Enter)" />
    </div>

    <button id="addBtn" class="primary">ì¶”ê°€</button>

    <!-- logged out -->
    <button id="loginOpenBtn">ë¡œê·¸ì¸</button>
    <button id="signupOpenBtn">íšŒì›ê°€ì…</button>

    <!-- logged in -->
    <button id="accountOpenBtn" style="display:none">ê³„ì •</button>
  </div>

  <!-- Place floating card -->
  <aside id="placeCard" class="float" style="right:14px; bottom:14px; width:min(440px,92vw); display:none">
    <div class="floatHeader">
      <div style="flex:1;min-width:0">
        <h3 id="placeName">ê°€ê²Œ</h3>
        <div class="sub" id="placeAddr"></div>
        <div class="sub" id="placeMeta"></div>
      </div>
      <button id="closePlaceBtn">ë‹«ê¸°</button>
    </div>
    <div class="floatBody">
      <div class="hint" id="placeHint">ë°©ë¬¸ ê¸°ë¡ì€ ê³µê°œ. ë¡œê·¸ì¸í•˜ë©´ ì‘ì„±/ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥.</div>

      <div class="section">
        <h4 class="sectionTitle">ë°©ë¬¸ ê¸°ë¡</h4>
        <div id="visits"></div>
      </div>

      <div class="section" id="editorWrap" style="display:none">
        <h4 class="sectionTitle" id="editorTitle">ë°©ë¬¸ê¸° ì“°ê¸°</h4>

        <div class="grid">
          <div>
            <label>ë°©ë¬¸ ë‚ ì§œ</label>
            <input id="visitDate" type="date" />
          </div>
          <div>
            <label>í‰ì  (0~5)</label>
            <input id="visitRating" type="number" min="0" max="5" step="0.5" placeholder="4.5" />
          </div>
        </div>

        <div style="margin-top:10px">
          <label>ë°©ë¬¸ê¸°</label>
          <textarea id="visitContent" placeholder="ë¬¸ì„œì²˜ëŸ¼ ê¸¸ê²Œ ì ì–´ë„ ë¨"></textarea>
        </div>

        <div class="row">
          <button id="cancelEditBtn" style="display:none">í¸ì§‘ ì·¨ì†Œ</button>
          <button id="saveVisitBtn" class="primary">ì €ì¥</button>
        </div>

        <div class="hint" style="margin-top:10px">
          ì‘ì„±ì í‘œì‹œëŠ” ì´ë©”ì¼ì´ ì•„ë‹ˆë¼ ë‹‰ë„¤ì„.
        </div>
      </div>

      <div class="section" id="needLoginHint" style="display:none">
        <div class="hint">ë¡œê·¸ì¸ + ë‹‰ë„¤ì„ ì„¤ì •ì´ ëë‚˜ë©´ ì‘ì„± ê°€ëŠ¥.</div>
      </div>
    </div>
  </aside>

  <!-- Add place modal -->
  <div id="addOverlay" class="overlay">
    <div class="modal">
      <div class="modalHeader">
        <h3>ìŒì‹ì  ì¶”ê°€</h3>
        <button id="closeAddBtn">ë‹«ê¸°</button>
      </div>
      <div class="modalBody">
        <div class="grid" style="grid-template-columns:1fr 1fr">
          <div>
            <label>ê°€ê²Œ ì´ë¦„</label>
            <input id="newName" placeholder="ì˜ˆ: í…í‚¤ë¼ë©˜" />
          </div>
          <div>
            <label>ì£¼ì†Œ(ê²€ìƒ‰ì–´)</label>
            <input id="newAddr" placeholder="ì˜ˆ: ê°•ë‚¨ ë…¼í˜„ë¡œ30ê¸¸ 43" />
          </div>
        </div>

        <div class="row" style="justify-content:flex-start;margin-top:10px">
          <button id="addrSearchBtn" class="primary">ì£¼ì†Œ í›„ë³´ ë³´ê¸°</button>
          <span id="geoStatus" class="hint"></span>
        </div>

        <div class="hint" style="margin-top:8px">
          ì¤‘ë³µ ì²´í¬: (ì´ë¦„+ì£¼ì†Œ) + (ì¢Œí‘œ 30m ê·¼ì ‘).  
          ì´ë¯¸ ìˆìœ¼ë©´ â€œì´ë¯¸ ë“±ë¡ë¨â€ ì•ˆë‚´í•˜ê³  ê·¸ ê°€ê²Œë¡œ ì´ë™í•´.
        </div>

        <div id="results" class="results"></div>
      </div>
    </div>
  </div>

  <!-- Login modal -->
  <div id="loginOverlay" class="overlay">
    <div class="modal" style="width:min(520px,96vw)">
      <div class="modalHeader">
        <h3>ë¡œê·¸ì¸</h3>
        <button id="closeLoginBtn">ë‹«ê¸°</button>
      </div>
      <div class="modalBody">
        <div class="card">
          <label>ì´ë©”ì¼</label>
          <input id="loginEmail" type="email" placeholder="you@example.com" />
          <label>ë¹„ë°€ë²ˆí˜¸</label>
          <input id="loginPassword" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
          <div class="row">
            <button id="loginBtn" class="primary">ë¡œê·¸ì¸</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Signup modal -->
  <div id="signupOverlay" class="overlay">
    <div class="modal" style="width:min(560px,96vw)">
      <div class="modalHeader">
        <h3>íšŒì›ê°€ì…</h3>
        <button id="closeSignupBtn">ë‹«ê¸°</button>
      </div>
      <div class="modalBody">
        <div class="card">
          <label>ë‹‰ë„¤ì„ (í•„ìˆ˜, ì¤‘ë³µ ë¶ˆê°€)</label>
          <input id="signupNickname" placeholder="ì˜ˆ: jaewon" maxlength="20" />
          <label>ì´ë©”ì¼</label>
          <input id="signupEmail" type="email" placeholder="you@example.com" />
          <label>ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)</label>
          <input id="signupPassword" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
          <div class="row">
            <button id="signupBtn" class="primary">íšŒì›ê°€ì…</button>
          </div>
          <div class="hint" style="margin-top:10px">
            ë‹‰ë„¤ì„ ì—†ì´ ê°€ì… ì‹œë„í•˜ë©´ DB íŠ¸ë¦¬ê±°ê°€ ê°€ì… ìì²´ë¥¼ ê±°ì ˆí•¨.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Account modal -->
  <div id="accountOverlay" class="overlay">
    <div class="modal" style="width:min(640px,96vw)">
      <div class="modalHeader">
        <h3>ê³„ì •</h3>
        <button id="closeAccountBtn">ë‹«ê¸°</button>
      </div>
      <div class="modalBody">
        <div class="card">
          <div class="hint">í˜„ì¬ ë¡œê·¸ì¸</div>
          <div id="accountLine" style="font-weight:1000;margin-top:6px"></div>

          <div style="margin-top:12px">
            <label>ë‹‰ë„¤ì„</label>
            <input id="nickname" maxlength="20" />
            <div class="row">
              <button id="saveNickBtn" class="primary">ë‹‰ë„¤ì„ ë³€ê²½</button>
              <button id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
            <div class="hint" style="margin-top:8px">
              ë‹‰ë„¤ì„ì€ ê³µê°œë˜ê³ , ì¤‘ë³µì´ë©´ ì €ì¥ ì‹¤íŒ¨.
            </div>
          </div>

          <div class="section">
            <h4 class="sectionTitle">ë‚´ í†µê³„</h4>
            <div class="statGrid">
              <div class="stat">
                <div class="k">ë‚´ê°€ ì¶”ê°€í•œ ê°€ê²Œ</div>
                <div class="v" id="myPlacesCount">-</div>
              </div>
              <div class="stat">
                <div class="k">ë‚´ê°€ ë‚¨ê¸´ ë°©ë¬¸ê¸°</div>
                <div class="v" id="myVisitsCount">-</div>
              </div>
            </div>
          </div>

          <div class="hint" style="margin-top:10px">
            ë‹‰ë„¤ì„ì´ ë¹„ì–´ ìˆìœ¼ë©´ â€œì¶”ê°€/ì €ì¥/ìˆ˜ì •/ì‚­ì œâ€ ë²„íŠ¼ì´ ë§‰í˜.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"><span class="dot"></span><span id="toastText">.</span></div>

<script>
/*********** êµì²´ ***********/
const SB_URL = "https://tqybsmrmzxnfuwypbazn.supabase.co";
const SB_KEY = "sb_publishable_NOdwos9jU0jwL0AzvZrHHg_KSH5f2e1";
/****************************/

const $ = (id) => document.getElementById(id);
const esc = (s)=>String(s??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;");
const todayISO = () => new Date().toISOString().slice(0,10);

function toast(msg){
  $('toastText').textContent = msg;
  $('toast').classList.add('show');
  clearTimeout(toast._tm);
  toast._tm = setTimeout(()=> $('toast').classList.remove('show'), 2400);
}
function open(el){ el.classList.add('open'); }
function close(el){ el.classList.remove('open'); }

const state = {
  sb: null,
  user: null,
  myProfile: null,              // {id, nickname}
  nameByUserId: new Map(),       // user_id -> nickname
  map: null,
  geocoder: null,
  places: [],
  markers: new Map(),
  selectedPlace: null,
  editingVisitId: null
};

function configured(){
  return SB_URL && SB_KEY && !SB_URL.includes("YOUR_") && !SB_KEY.includes("YOUR_");
}

function hasNickname(){
  return !!(state.myProfile?.nickname && String(state.myProfile.nickname).trim());
}

function requireNicknameOrGuide(){
  if(!state.user){
    toast('ë¡œê·¸ì¸ í•„ìš”');
    open($('loginOverlay'));
    return false;
  }
  if(!hasNickname()){
    toast('ë‹‰ë„¤ì„ì´ í•„ìš”í•´. ê³„ì •ì—ì„œ ì„¤ì •í•´ì¤˜.');
    open($('accountOverlay'));
    return false;
  }
  return true;
}

function displayName(user_id, fallbackEmail){
  const nick = state.nameByUserId.get(user_id);
  if(nick && String(nick).trim()) return nick;
  if(fallbackEmail) return fallbackEmail;
  return 'user';
}

async function fetchNicknames(userIds){
  const ids = [...new Set((userIds || []).filter(Boolean))].filter(id => !state.nameByUserId.has(id));
  if(ids.length === 0) return;

  const { data, error } = await state.sb
    .from('profiles')
    .select('id, nickname')
    .in('id', ids);

  if(error){ console.error(error); return; }

  for(const row of (data ?? [])){
    state.nameByUserId.set(row.id, row.nickname || '');
  }
}

async function ensureMyProfile(){
  const u = state.user;
  if(!u) return;

  // profile ì½ê¸°
  const { data, error } = await state.sb
    .from('profiles')
    .select('id, nickname')
    .eq('id', u.id)
    .maybeSingle();

  if(error){ console.error(error); }

  state.myProfile = data ?? { id: u.id, nickname: '' };
  state.nameByUserId.set(u.id, state.myProfile.nickname || '');
}

async function loadMyStats(){
  if(!state.user) return;

  const p = await state.sb
    .from('places')
    .select('id', { count: 'exact', head: true })
    .eq('user_id', state.user.id);

  const v = await state.sb
    .from('visits')
    .select('id', { count: 'exact', head: true })
    .eq('user_id', state.user.id);

  $('myPlacesCount').textContent = String(p.count ?? 0);
  $('myVisitsCount').textContent = String(v.count ?? 0);
}

function updateDockUI(){
  const loggedIn = !!state.user;

  $('loginOpenBtn').style.display = loggedIn ? 'none' : 'inline-flex';
  $('signupOpenBtn').style.display = loggedIn ? 'none' : 'inline-flex';
  $('accountOpenBtn').style.display = loggedIn ? 'inline-flex' : 'none';

  if(loggedIn){
    const nick = hasNickname() ? state.myProfile.nickname : 'ê³„ì •';
    $('accountOpenBtn').textContent = nick;
  }

  // add ë²„íŠ¼ì€ ë¡œê·¸ì¸+ë‹‰ë„¤ì„ ìˆì„ ë•Œë§Œ â€œì‹¤ì œ ì¶”ê°€ ì§„í–‰â€
  // (ë²„íŠ¼ ìì²´ëŠ” ë³´ì´ë˜, ëˆ„ë¥´ë©´ ì•ˆë‚´)
  $('addBtn').disabled = false;

  // ë°©ë¬¸ê¸° ì—ë””í„° ë…¸ì¶œ/ìˆ¨ê¹€
  if(state.selectedPlace){
    if(loggedIn && hasNickname()){
      $('editorWrap').style.display = 'block';
      $('needLoginHint').style.display = 'none';
    }else{
      $('editorWrap').style.display = 'none';
      $('needLoginHint').style.display = 'block';
    }
  }
}

async function initSupabase(){
  if(!configured()){ toast('Supabase URL/KEYë¥¼ index.htmlì— ë„£ì–´ì¤˜'); return; }
  if(!window.supabase?.createClient){ toast('Supabase SDK ë¡œë”© ì‹¤íŒ¨'); return; }

  state.sb = window.supabase.createClient(SB_URL, SB_KEY, {
    auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
  });

  const { data } = await state.sb.auth.getSession();
  state.user = data?.session?.user ?? null;
  if(state.user){
    await ensureMyProfile();
  }
  updateDockUI();

  state.sb.auth.onAuthStateChange(async (_event, session) => {
    state.user = session?.user ?? null;
    state.myProfile = null;

    if(state.user){
      await ensureMyProfile();
      await loadMyStats();
    }else{
      $('myPlacesCount').textContent='-';
      $('myVisitsCount').textContent='-';
    }

    updateDockUI();
    if(state.selectedPlace) await loadVisitsAndRender(state.selectedPlace.id);
  });
}

function initMap(){
  if(!(window.kakao && window.kakao.maps)){
    toast('ì¹´ì¹´ì˜¤ ì§€ë„ SDK ë¡œë”© ì‹¤íŒ¨ (í‚¤/ë„ë©”ì¸/ì¹´ì¹´ì˜¤ë§µ ON í™•ì¸)');
    return;
  }
  const center = new kakao.maps.LatLng(37.5665, 126.9780);
  state.map = new kakao.maps.Map($('map'), { center, level: 6 });
  state.geocoder = new kakao.maps.services.Geocoder();
}

async function loadPlaces(){
  const { data, error } = await state.sb
    .from('places')
    .select('*')
    .order('created_at', { ascending:false });

  if(error){ console.error(error); toast('places ë¡œë”© ì‹¤íŒ¨'); return; }
  state.places = data ?? [];
  await fetchNicknames(state.places.map(p => p.user_id));
  renderMarkers();
}

function clearMarkers(){
  for(const m of state.markers.values()) m.setMap(null);
  state.markers.clear();
}

function renderMarkers(){
  if(!state.map) return;
  clearMarkers();

  for(const p of state.places){
    const marker = new kakao.maps.Marker({
      position: new kakao.maps.LatLng(p.lat, p.lng)
    });
    marker.setMap(state.map);
    kakao.maps.event.addListener(marker, 'click', ()=> openPlace(p.id));
    state.markers.set(p.id, marker);
  }
}

function showPlaceCard(show){
  $('placeCard').style.display = show ? 'block' : 'none';
}

function resetEditor(){
  state.editingVisitId = null;
  $('editorTitle').textContent = 'ë°©ë¬¸ê¸° ì“°ê¸°';
  $('saveVisitBtn').textContent = 'ì €ì¥';
  $('cancelEditBtn').style.display = 'none';
  $('visitDate').value = todayISO();
  $('visitRating').value = '';
  $('visitContent').value = '';
}

async function openPlace(placeId){
  const place = state.places.find(p => p.id === placeId);
  if(!place) return;

  state.selectedPlace = place;
  await fetchNicknames([place.user_id]);

  $('placeName').textContent = place.name;
  $('placeAddr').textContent = place.address;
  $('placeMeta').textContent = `ì¶”ê°€ì: ${displayName(place.user_id)}`;

  showPlaceCard(true);
  resetEditor();
  updateDockUI();

  const pos = new kakao.maps.LatLng(place.lat, place.lng);
  state.map.setCenter(pos);
  state.map.setLevel(Math.min(state.map.getLevel(), 4));

  await loadVisitsAndRender(place.id);
}

async function loadVisitsAndRender(placeId){
  const wrap = $('visits');
  wrap.innerHTML = '<div class="hint">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';

  const { data, error } = await state.sb
    .from('visits')
    .select('*')
    .eq('place_id', placeId)
    .order('visited_at', { ascending:false })
    .order('created_at', { ascending:false });

  if(error){ console.error(error); toast('visits ë¡œë”© ì‹¤íŒ¨'); wrap.innerHTML=''; return; }

  const items = data ?? [];
  await fetchNicknames(items.map(v => v.user_id));

  if(items.length === 0){
    wrap.innerHTML = '<div class="hint">ì•„ì§ ë°©ë¬¸ ê¸°ë¡ ì—†ìŒ.</div>';
    return;
  }

  wrap.innerHTML = '';
  for(const v of items){
    const author = displayName(v.user_id, v.author_email);
    const isMine = !!(state.user && v.user_id === state.user.id);

    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `
      <div class="visitTop">
        <div style="font-weight:1000">${esc(v.visited_at)}</div>
        <div class="badge">${v.rating == null ? 'í‰ì  ì—†ìŒ' : ('í‰ì  ' + esc(v.rating))}</div>
      </div>
      <div class="sub" style="margin-top:6px">ì‘ì„±ì: ${esc(author)}</div>
      <div class="visitContent">${esc(v.content || '')}</div>
      ${isMine ? `
        <div class="miniActions">
          <button data-act="edit">ìˆ˜ì •</button>
          <button data-act="del">ì‚­ì œ</button>
        </div>
      ` : ''}
    `;

    if(isMine){
      div.querySelector('[data-act="edit"]').addEventListener('click', ()=>{
        if(!requireNicknameOrGuide()) return;
        state.editingVisitId = v.id;
        $('editorTitle').textContent = 'ë°©ë¬¸ê¸° ìˆ˜ì •';
        $('saveVisitBtn').textContent = 'ìˆ˜ì • ì €ì¥';
        $('cancelEditBtn').style.display = 'inline-flex';
        $('visitDate').value = v.visited_at || todayISO();
        $('visitRating').value = (v.rating ?? '');
        $('visitContent').value = v.content || '';
        toast('í¸ì§‘ ëª¨ë“œ');
      });

      div.querySelector('[data-act="del"]').addEventListener('click', async ()=>{
        if(!requireNicknameOrGuide()) return;
        if(!confirm('ì´ ë°©ë¬¸ê¸°ë¥¼ ì‚­ì œí• ê¹Œ?')) return;
        const { error } = await state.sb.from('visits').delete().eq('id', v.id);
        if(error){ console.error(error); toast('ì‚­ì œ ì‹¤íŒ¨'); return; }
        toast('ì‚­ì œë¨');
        await loadVisitsAndRender(placeId);
        await loadMyStats();
        resetEditor();
      });
    }

    wrap.appendChild(div);
  }
}

function haversineMeters(lat1,lng1,lat2,lng2){
  const R = 6371000;
  const toRad = (x)=> x*Math.PI/180;
  const dLat = toRad(lat2-lat1);
  const dLng = toRad(lng2-lng1);
  const a = Math.sin(dLat/2)**2 +
            Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*(Math.sin(dLng/2)**2);
  const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}

function isSeoulByCoord(lat, lng){
  return new Promise((resolve) => {
    state.geocoder.coord2RegionCode(lng, lat, (res, status) => {
      if(status !== kakao.maps.services.Status.OK || !res || res.length === 0){
        resolve(true);
        return;
      }
      const any = res.find(x => x.region_1depth_name) || res[0];
      resolve((any.region_1depth_name || '').includes('ì„œìš¸'));
    });
  });
}

async function findDuplicateByNameAddress(name, address){
  const { data, error } = await state.sb
    .from('places')
    .select('id, lat, lng')
    .eq('name', name)
    .eq('address', address)
    .limit(1);

  if(error){ console.error(error); return null; }
  return (data && data.length) ? data[0] : null;
}

async function findDuplicateByProximity(lat, lng, thresholdMeters = 30){
  // bounding boxë¡œ ì¢í˜€ì„œ ê°€ì ¸ì˜¨ ë’¤ ì‹¤ì œ ê±°ë¦¬ ê³„ì‚°
  const dLat = 0.0006; // ì•½ 66m
  const dLng = 0.00075; // ì„œìš¸ ìœ„ë„ ê¸°ì¤€ ëŒ€ëµ 66m ê·¼ì‚¬
  const { data, error } = await state.sb
    .from('places')
    .select('id, lat, lng')
    .gte('lat', lat - dLat)
    .lte('lat', lat + dLat)
    .gte('lng', lng - dLng)
    .lte('lng', lng + dLng)
    .limit(40);

  if(error){ console.error(error); return null; }

  let best = null;
  let bestDist = Infinity;
  for(const p of (data ?? [])){
    const dist = haversineMeters(lat, lng, p.lat, p.lng);
    if(dist < bestDist){
      bestDist = dist;
      best = p;
    }
  }
  if(best && bestDist <= thresholdMeters) return { ...best, dist: bestDist };
  return null;
}

async function createPlace({ name, address, lat, lng }){
  if(!requireNicknameOrGuide()) return null;

  // 1) ì´ë¦„+ì£¼ì†Œ ì¤‘ë³µ
  const dup1 = await findDuplicateByNameAddress(name, address);
  if(dup1){
    toast('ì´ë¯¸ ë“±ë¡ëœ ê°€ê²Œì•¼. ê·¸ìª½ìœ¼ë¡œ ì´ë™í• ê²Œ.');
    return { id: dup1.id, existed:true };
  }

  // 2) ì¢Œí‘œ ê·¼ì ‘ ì¤‘ë³µ
  const dup2 = await findDuplicateByProximity(lat, lng, 30);
  if(dup2){
    toast(`ê·¼ì²˜(${Math.round(dup2.dist)}m)ì— ì´ë¯¸ ë“±ë¡ëœ ê°€ê²Œê°€ ìˆì–´. ê·¸ìª½ìœ¼ë¡œ ì´ë™í• ê²Œ.`);
    return { id: dup2.id, existed:true };
  }

  const payload = { user_id: state.user.id, name, address, lat, lng };

  const { data, error } = await state.sb
    .from('places')
    .insert(payload)
    .select('*')
    .single();

  if(error){
    console.error(error);
    // ìœ ë‹ˆí¬ ì œì•½ ìœ„ë°˜ ê°™ì€ ê²½ìš°: ë‹¤ì‹œ ì°¾ì•„ì„œ ì´ë™
    const fallback = await findDuplicateByNameAddress(name, address);
    if(fallback){
      toast('ì´ë¯¸ ë“±ë¡ëœ ê°€ê²Œì•¼. ê·¸ìª½ìœ¼ë¡œ ì´ë™í• ê²Œ.');
      return { id: fallback.id, existed:true };
    }
    toast(error.message || 'ê°€ê²Œ ì €ì¥ ì‹¤íŒ¨');
    return null;
  }

  return { ...data, existed:false };
}

async function saveVisit(){
  if(!requireNicknameOrGuide()) return;
  if(!state.selectedPlace){ toast('ê°€ê²Œë¶€í„° ì„ íƒ'); return; }

  const visited_at = $('visitDate').value || todayISO();
  const ratingRaw = $('visitRating').value;
  const rating = (ratingRaw === '') ? null : Math.max(0, Math.min(5, Number(ratingRaw)));
  const content = ($('visitContent').value || '').trim();
  if(!content){ toast('ë°©ë¬¸ê¸° ë‚´ìš©ì„ ì¨ì¤˜'); return; }

  $('saveVisitBtn').disabled = true;
  try{
    if(state.editingVisitId){
      const { error } = await state.sb
        .from('visits')
        .update({ visited_at, rating, content })
        .eq('id', state.editingVisitId);

      if(error){ console.error(error); toast('ìˆ˜ì • ì‹¤íŒ¨'); return; }
      toast('ìˆ˜ì •ë¨');
      resetEditor();
    }else{
      const payload = {
        user_id: state.user.id,
        author_email: state.user.email || null,
        place_id: state.selectedPlace.id,
        visited_at,
        rating,
        content
      };

      const { error } = await state.sb.from('visits').insert(payload);
      if(error){ console.error(error); toast('ì €ì¥ ì‹¤íŒ¨'); return; }
      toast('ì €ì¥ë¨');
      $('visitContent').value = '';
      $('visitRating').value = '';
    }

    await loadVisitsAndRender(state.selectedPlace.id);
    await loadMyStats();
  } finally {
    $('saveVisitBtn').disabled = false;
  }
}

/* ===== UI events ===== */
window.addEventListener('DOMContentLoaded', () => {
  $('visitDate').value = todayISO();

  $('closePlaceBtn').addEventListener('click', ()=>{
    showPlaceCard(false);
    state.selectedPlace = null;
    resetEditor();
  });

  $('addBtn').addEventListener('click', ()=>{
    if(!requireNicknameOrGuide()) return;
    open($('addOverlay'));
  });
  $('closeAddBtn').addEventListener('click', ()=> close($('addOverlay')));

  $('loginOpenBtn').addEventListener('click', ()=> open($('loginOverlay')));
  $('closeLoginBtn').addEventListener('click', ()=> close($('loginOverlay')));

  $('signupOpenBtn').addEventListener('click', ()=> open($('signupOverlay')));
  $('closeSignupBtn').addEventListener('click', ()=> close($('signupOverlay')));

  $('accountOpenBtn').addEventListener('click', async ()=>{
    open($('accountOverlay'));
    await loadMyStats();
    $('accountLine').textContent = state.user?.email || '';
    $('nickname').value = state.myProfile?.nickname || '';
  });
  $('closeAccountBtn').addEventListener('click', ()=> close($('accountOverlay')));

  $('cancelEditBtn').addEventListener('click', ()=>{
    resetEditor();
    toast('í¸ì§‘ ì·¨ì†Œ');
  });

  $('saveVisitBtn').addEventListener('click', saveVisit);

  $('loginBtn').addEventListener('click', async ()=>{
    const email = ($('loginEmail').value || '').trim();
    const password = $('loginPassword').value || '';
    if(!email || !password){ toast('ì´ë©”ì¼/ë¹„ë²ˆ ì…ë ¥'); return; }

    $('loginBtn').disabled = true;
    try{
      const { error } = await state.sb.auth.signInWithPassword({ email, password });
      if(error){ console.error(error); toast(error.message || 'ë¡œê·¸ì¸ ì‹¤íŒ¨'); return; }
      toast('ë¡œê·¸ì¸ ë¨');
      close($('loginOverlay'));
      await ensureMyProfile();
      await loadMyStats();
      updateDockUI();
    } finally {
      $('loginBtn').disabled = false;
    }
  });

  $('signupBtn').addEventListener('click', async ()=>{
    const nickname = ($('signupNickname').value || '').trim();
    const email = ($('signupEmail').value || '').trim();
    const password = $('signupPassword').value || '';

    if(!nickname){ toast('ë‹‰ë„¤ì„ì€ í•„ìˆ˜'); return; }
    if(!email || !password){ toast('ì´ë©”ì¼/ë¹„ë²ˆ ì…ë ¥'); return; }

    $('signupBtn').disabled = true;
    try{
      // nicknameì€ user metadataë¡œ ì „ë‹¬ë¨ -> DB íŠ¸ë¦¬ê±°ê°€ profiles ìƒì„±/ê²€ì¦
      const { error } = await state.sb.auth.signUp({
        email, password,
        options: { data: { nickname } }
      });

      if(error){
        console.error(error);
        toast(error.message || 'íšŒì›ê°€ì… ì‹¤íŒ¨');
        return;
      }
      toast('íšŒì›ê°€ì… ì™„ë£Œ. ì´ì œ ë¡œê·¸ì¸í•´ì¤˜.');
      close($('signupOverlay'));
      open($('loginOverlay'));
    } finally {
      $('signupBtn').disabled = false;
    }
  });

  $('saveNickBtn').addEventListener('click', async ()=>{
    if(!state.user){ toast('ë¡œê·¸ì¸ í•„ìš”'); return; }
    const nickname = ($('nickname').value || '').trim();
    if(!nickname){ toast('ë‹‰ë„¤ì„ì€ ë¹„ìš¸ ìˆ˜ ì—†ìŒ'); return; }

    $('saveNickBtn').disabled = true;
    try{
      const { error } = await state.sb
        .from('profiles')
        .update({ nickname })
        .eq('id', state.user.id);

      if(error){
        console.error(error);
        toast('ë‹‰ë„¤ì„ ë³€ê²½ ì‹¤íŒ¨(ì¤‘ë³µì¼ ìˆ˜ ìˆìŒ)');
        return;
      }

      state.myProfile = { id: state.user.id, nickname };
      state.nameByUserId.set(state.user.id, nickname);
      toast('ë‹‰ë„¤ì„ ë³€ê²½ë¨');
      updateDockUI();

      // í™”ë©´ ë°˜ì˜
      await loadPlaces();
      if(state.selectedPlace) await openPlace(state.selectedPlace.id);
    } finally {
      $('saveNickBtn').disabled = false;
    }
  });

  $('logoutBtn').addEventListener('click', async ()=>{
    await state.sb.auth.signOut();
    toast('ë¡œê·¸ì•„ì›ƒ');
    close($('accountOverlay'));
  });

  $('addrSearchBtn').addEventListener('click', ()=>{
    if(!state.geocoder){ toast('ì§€ë„ ì¤€ë¹„ ì•ˆ ë¨'); return; }

    const name = ($('newName').value || '').trim();
    const q = ($('newAddr').value || '').trim();
    if(!name){ toast('ê°€ê²Œ ì´ë¦„ë¶€í„°'); return; }
    if(!q){ toast('ì£¼ì†Œ(ê²€ìƒ‰ì–´)ë¶€í„°'); return; }

    $('geoStatus').textContent = 'ì°¾ëŠ” ì¤‘â€¦';
    $('results').innerHTML = '';

    state.geocoder.addressSearch(q, (result, status) => {
      if(status !== kakao.maps.services.Status.OK || !result || result.length === 0){
        $('geoStatus').textContent = 'ê²°ê³¼ ì—†ìŒ';
        return;
      }

      $('geoStatus').textContent = `í›„ë³´ ${result.length}ê°œ`;

      for(const r of result){
        const lat = Number(r.y);
        const lng = Number(r.x);
        const addr = (r.address_name || q).trim();

        const item = document.createElement('div');
        item.className = 'resultItem';
        item.innerHTML = `
          <div class="t">${esc(name)}</div>
          <div class="s">${esc(addr)}</div>
          <div class="s">ì¢Œí‘œ: ${lat.toFixed(5)}, ${lng.toFixed(5)}</div>
        `;

        item.addEventListener('click', async ()=>{
          const ok = await isSeoulByCoord(lat, lng);
          if(!ok){ toast('ì„œìš¸ì´ ì•„ë‹ˆë©´ ì €ì¥ ì•ˆ í•¨'); return; }

          const res = await createPlace({ name, address: addr, lat, lng });
          if(!res) return;

          close($('addOverlay'));
          $('newName').value = '';
          $('newAddr').value = '';
          $('results').innerHTML = '';
          $('geoStatus').textContent = '';

          await loadPlaces();
          await openPlace(res.id);
          if(!res.existed){
            await loadMyStats();
          }
        });

        $('results').appendChild(item);
      }
    });
  });

  $('q').addEventListener('keydown', (e)=>{
    if(e.key !== 'Enter') return;
    const q = ($('q').value || '').trim().toLowerCase();
    if(!q) return;

    const hit = state.places.find(p =>
      (p.name || '').toLowerCase().includes(q) ||
      (p.address || '').toLowerCase().includes(q)
    );
    if(!hit){ toast('ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ'); return; }
    openPlace(hit.id);
  });
});

/* ===== boot ===== */
window.addEventListener('load', async ()=>{
  initMap();
  await initSupabase();
  await loadPlaces();
  if(state.user){
    await ensureMyProfile();
    await loadMyStats();
    updateDockUI();
  }
});
</script>
</body>
</html>
