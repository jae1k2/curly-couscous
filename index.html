<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Seoul Shared Eats</title>

  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=5c2fb05e6765f133c747e1f5a2bdf64d&libraries=services"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0b0c10; --panel:#11131a; --card:#171a23;
      --text:#e9ecf1; --muted:#a7afbf; --line:#242a36;
      --accent:#7aa2ff; --shadow:0 10px 30px rgba(0,0,0,.35);
      --r:16px; --top:56px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:var(--bg);color:var(--text)}
    #map{position:fixed;left:0;right:0;top:var(--top);bottom:0}

    .topbar{
      position:fixed;left:0;right:0;top:0;height:var(--top);
      display:flex;align-items:center;gap:10px;padding:10px 12px;
      border-bottom:1px solid var(--line);
      background:rgba(11,12,16,.85);backdrop-filter:blur(10px);z-index:1000;
    }
    .brand{font-weight:800;letter-spacing:.2px;white-space:nowrap}
    .search{
      flex:1;max-width:760px;display:flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;border:1px solid var(--line);
      background:rgba(23,26,35,.75)
    }
    .search input{width:100%;border:0;outline:0;background:transparent;color:var(--text);font-size:14px}
    .search input::placeholder{color:rgba(167,175,191,.7)}

    button{
      border:1px solid var(--line);background:rgba(23,26,35,.75);color:var(--text);
      padding:10px 12px;border-radius:999px;cursor:pointer;
    }
    button.primary{background:rgba(122,162,255,.16);border-color:rgba(122,162,255,.45)}
    button:disabled{opacity:.55;cursor:not-allowed}

    .panel{
      position:fixed;top:var(--top);right:0;bottom:0;width:min(420px,92vw);
      background:rgba(17,19,26,.90);backdrop-filter:blur(10px);
      border-left:1px solid var(--line);box-shadow:var(--shadow);
      transform:translateX(102%);transition:transform .22s ease;z-index:1200;
      display:flex;flex-direction:column;
    }
    .panel.open{transform:translateX(0)}
    .panelHeader{padding:14px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:flex-start}
    .panelHeader h2{margin:0;font-size:16px;line-height:1.2}
    .sub{margin-top:6px;color:var(--muted);font-size:12px;line-height:1.35;word-break:break-word}
    .panelBody{padding:14px;overflow:auto;flex:1}
    .hint{font-size:12px;color:var(--muted);line-height:1.45}

    .section{margin-top:14px}
    .sectionTitle{margin:0 0 10px;font-size:12px;color:rgba(167,175,191,.9);text-transform:uppercase;letter-spacing:.2px}

    .card{background:rgba(23,26,35,.8);border:1px solid var(--line);border-radius:var(--r);padding:12px;margin-bottom:10px}
    .visitTop{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .badge{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.12);white-space:nowrap}
    .visitContent{margin-top:10px;white-space:pre-wrap;font-size:13px;line-height:1.55}

    label{display:block;font-size:12px;color:rgba(167,175,191,.95);margin:0 0 6px}
    input, textarea{
      width:100%;border:1px solid var(--line);background:rgba(23,26,35,.8);
      color:var(--text);border-radius:12px;padding:10px;outline:none;font-size:13px
    }
    textarea{min-height:120px;resize:vertical;line-height:1.55}
    .grid{display:grid;grid-template-columns:1fr 120px;gap:10px}
    .row{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:2000;display:none;align-items:center;justify-content:center;padding:16px}
    .overlay.open{display:flex}
    .modal{width:min(720px,96vw);background:rgba(17,19,26,.92);border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow);overflow:hidden}
    .modalHeader{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:10px}
    .modalHeader h3{margin:0;font-size:15px;flex:1}
    .modalBody{padding:16px}
    .results{margin-top:10px;display:flex;flex-direction:column;gap:8px}
    .resultItem{padding:12px;border:1px solid var(--line);border-radius:14px;background:rgba(23,26,35,.8);cursor:pointer}
    .resultItem:hover{border-color:rgba(122,162,255,.55)}
    .resultItem .t{font-weight:800;font-size:13px;margin-bottom:4px}
    .resultItem .s{font-size:12px;color:var(--muted);line-height:1.35}
    .statGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .stat{background:rgba(0,0,0,.12);border:1px solid var(--line);border-radius:14px;padding:10px}
    .stat .k{font-size:12px;color:var(--muted)}
    .stat .v{font-size:18px;font-weight:900;margin-top:6px}

    .toast{
      position:fixed;left:50%;transform:translateX(-50%);bottom:18px;z-index:3000;
      background:rgba(23,26,35,.9);border:1px solid var(--line);
      border-radius:999px;padding:10px 14px;box-shadow:var(--shadow);
      display:none;gap:10px;align-items:center
    }
    .toast.show{display:flex}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--accent)}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">ğŸœ Seoul Shared Eats</div>

    <div class="search" title="ê°€ê²Œ ê²€ìƒ‰ (Enter)">
      <span style="opacity:.75">ğŸ”</span>
      <input id="q" placeholder="ê°€ê²Œ ê²€ìƒ‰ (Enter)" />
    </div>

    <button id="addBtn" class="primary">ì¶”ê°€í•˜ê¸°</button>
    <button id="authBtn">ë¡œê·¸ì¸</button>
  </div>

  <div id="map"></div>

  <aside id="panel" class="panel" aria-hidden="true">
    <div class="panelHeader">
      <div style="flex:1;min-width:0">
        <h2 id="placeName">ê°€ê²Œ ì„ íƒí•´ì¤˜</h2>
        <div class="sub" id="placeAddr">ë§ˆì»¤ ëˆ„ë¥´ë©´ ëœ¸</div>
        <div class="sub" id="placeMeta"></div>
      </div>
      <button id="closePanelBtn">ë‹«ê¸°</button>
    </div>

    <div class="panelBody">
      <div class="hint" id="panelHint">ë§ˆì»¤ í´ë¦­í•˜ë©´ ë°©ë¬¸ ê¸°ë¡ì´ ë³´ì—¬.</div>

      <div class="section">
        <h4 class="sectionTitle">ë°©ë¬¸ ê¸°ë¡</h4>
        <div id="visits"></div>
      </div>

      <div class="section" id="editor" style="display:none">
        <h4 class="sectionTitle">ë°©ë¬¸ê¸° ì“°ê¸°</h4>

        <div class="grid">
          <div>
            <label>ë°©ë¬¸ ë‚ ì§œ</label>
            <input id="visitDate" type="date" />
          </div>
          <div>
            <label>í‰ì  (0~5)</label>
            <input id="visitRating" type="number" min="0" max="5" step="0.5" placeholder="4.5" />
          </div>
        </div>

        <div style="margin-top:10px">
          <label>ë°©ë¬¸ê¸°</label>
          <textarea id="visitContent" placeholder="ë¬¸ì„œì²˜ëŸ¼ ê¸¸ê²Œ ì ì–´ë„ ë¨"></textarea>
        </div>

        <div class="row">
          <button id="saveVisitBtn" class="primary">ì €ì¥</button>
        </div>

        <div class="hint" style="margin-top:10px">
          ë°©ë¬¸ê¸°ëŠ” ê³µê°œ. ì‘ì„±ìëŠ” â€œë‹‰ë„¤ì„â€ìœ¼ë¡œ í‘œì‹œë¨.
        </div>
      </div>

      <div class="section" id="loginHint" style="display:none">
        <div class="hint">ë¡œê·¸ì¸í•˜ë©´ ë°©ë¬¸ê¸°ë¥¼ ë‚¨ê¸¸ ìˆ˜ ìˆì–´.</div>
      </div>
    </div>
  </aside>

  <!-- Add overlay -->
  <div id="addOverlay" class="overlay" aria-hidden="true">
    <div class="modal">
      <div class="modalHeader">
        <h3>ìƒˆ ìŒì‹ì  ì¶”ê°€</h3>
        <button id="closeAddBtn">ë‹«ê¸°</button>
      </div>

      <div class="modalBody">
        <div class="grid" style="grid-template-columns:1fr 1fr">
          <div>
            <label>ê°€ê²Œ ì´ë¦„</label>
            <input id="newName" type="text" placeholder="ì˜ˆ: OOë¼ë©˜" />
          </div>
          <div>
            <label>ì£¼ì†Œ(ê²€ìƒ‰ì–´)</label>
            <input id="newAddr" type="text" placeholder="ì˜ˆ: ê°•ë‚¨ ë…¼í˜„ë¡œ30ê¸¸ 43" />
          </div>
        </div>

        <div class="row" style="justify-content:flex-start;margin-top:10px">
          <button id="addrSearchBtn" class="primary">ì£¼ì†Œ ì°¾ê¸°</button>
          <span id="geoStatus" class="hint"></span>
        </div>

        <div class="hint" style="margin-top:8px">
          í›„ë³´ê°€ ì—¬ëŸ¬ ê°œë©´ í•˜ë‚˜ ê³¨ë¼. (ì„œìš¸ë§Œ ì €ì¥)  
          ê°™ì€ ì´ë¦„+ì£¼ì†Œê°€ ì´ë¯¸ ìˆìœ¼ë©´ â€œì´ë¯¸ ë“±ë¡ë¨â€ ì•ˆë‚´ í›„ ê·¸ ê°€ê²Œë¡œ ì´ë™í•¨.
        </div>

        <div id="results" class="results"></div>
      </div>
    </div>
  </div>

  <!-- Auth overlay -->
  <div id="authOverlay" class="overlay" aria-hidden="true">
    <div class="modal" style="width:min(560px,96vw)">
      <div class="modalHeader">
        <h3 id="authTitle">ë¡œê·¸ì¸ / íšŒì›ê°€ì…</h3>
        <button id="closeAuthBtn">ë‹«ê¸°</button>
      </div>

      <div class="modalBody">

        <!-- ë¡œê·¸ì¸/íšŒì›ê°€ì… ì¹´ë“œ (ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œë§Œ í‘œì‹œ) -->
        <div class="card" id="loginCard">
          <label>ì´ë©”ì¼</label>
          <input id="email" type="email" placeholder="you@example.com" />
          <label>ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)</label>
          <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
          <div class="row">
            <button id="loginBtn" class="primary">ë¡œê·¸ì¸</button>
            <button id="signupBtn">íšŒì›ê°€ì…</button>
          </div>
          <div class="hint" style="margin-top:10px">
            íšŒì›ê°€ì…ì´ ì•ˆ ë˜ë©´ Supabaseì—ì„œ Email provider / Signups ON í™•ì¸.
          </div>
        </div>

        <!-- ê³„ì • ì¹´ë“œ (ë¡œê·¸ì¸ ìƒíƒœì—ì„œë§Œ í‘œì‹œ) -->
        <div class="card" id="accountCard" style="display:none">
          <div class="hint">í˜„ì¬ ë¡œê·¸ì¸</div>
          <div id="accountLine" style="font-weight:900;margin-top:6px"></div>

          <div style="margin-top:12px">
            <label>ë‹‰ë„¤ì„</label>
            <input id="nickname" type="text" placeholder="ì˜ˆ: jaewon" maxlength="20" />
            <div class="row">
              <button id="saveNickBtn" class="primary">ë‹‰ë„¤ì„ ì €ì¥</button>
              <button id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
            <div class="hint" style="margin-top:8px">
              ë‹‰ë„¤ì„ì€ ê³µê°œë¼. ì¤‘ë³µì´ë©´ ì €ì¥ì´ ê±°ì ˆë¨.
            </div>
          </div>

          <div class="section">
            <h4 class="sectionTitle">ë‚´ í™œë™ í†µê³„</h4>
            <div class="statGrid">
              <div class="stat">
                <div class="k">ë‚´ê°€ ì¶”ê°€í•œ ê°€ê²Œ</div>
                <div class="v" id="myPlacesCount">-</div>
              </div>
              <div class="stat">
                <div class="k">ë‚´ê°€ ë‚¨ê¸´ ë°©ë¬¸ê¸°</div>
                <div class="v" id="myVisitsCount">-</div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div id="toast" class="toast"><span class="dot"></span><span id="toastText">.</span></div>

  <script>
    /*********** ë„ˆê°€ êµì²´í•  ê°’ ***********/
    const SB_URL = "https://tqybsmrmzxnfuwypbazn.supabase.co";
    const SB_KEY = "sb_publishable_NOdwos9jU0jwL0AzvZrHHg_KSH5f2e1";
    /*************************************/

    const $ = (id) => document.getElementById(id);
    const esc = (s)=>String(s??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;");
    const todayISO = () => new Date().toISOString().slice(0,10);
    const shortId = (id) => (id ? String(id).slice(0,8) : '');

    function toast(msg){
      $('toastText').textContent = msg;
      $('toast').classList.add('show');
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=> $('toast').classList.remove('show'), 2400);
    }
    function open(el){ el.classList.add('open'); el.setAttribute('aria-hidden','false'); }
    function close(el){ el.classList.remove('open'); el.setAttribute('aria-hidden','true'); }

    const state = {
      sb: null,
      user: null,
      myProfile: null,              // {id, nickname}
      nameByUserId: new Map(),       // user_id -> nickname
      map: null,
      geocoder: null,
      places: [],
      markers: new Map(),
      selectedPlace: null
    };

    function configured(){
      return SB_URL && SB_KEY && !SB_URL.includes("YOUR_") && !SB_KEY.includes("YOUR_");
    }

    async function initSupabase(){
      if(!configured()){ toast('Supabase URL/KEYë¥¼ index.htmlì— ë„£ì–´ì¤˜'); return; }
      if(!window.supabase?.createClient){ toast('Supabase SDK ë¡œë”© ì‹¤íŒ¨'); return; }

      state.sb = window.supabase.createClient(SB_URL, SB_KEY, {
        auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
      });

      const { data } = await state.sb.auth.getSession();
      state.user = data?.session?.user ?? null;

      if(state.user){
        await ensureMyProfile();
      }
      updateAuthUI();

      state.sb.auth.onAuthStateChange(async (_event, session) => {
        state.user = session?.user ?? null;
        state.myProfile = null;

        if(state.user){
          await ensureMyProfile();
        }
        updateAuthUI();

        // ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ì§í›„: í†µê³„ ê°±ì‹  + (ì„ íƒëœ place ìˆìœ¼ë©´) ë°©ë¬¸ê¸° ê°±ì‹ 
        if(state.user){
          await loadMyStats();
        } else {
          $('myPlacesCount').textContent = '-';
          $('myVisitsCount').textContent = '-';
        }
        if(state.selectedPlace) await loadVisitsAndRender(state.selectedPlace.id);
      });
    }

    function displayName(user_id, fallbackEmail){
      const nick = state.nameByUserId.get(user_id);
      if(nick && String(nick).trim()) return nick;
      if(fallbackEmail) return fallbackEmail;
      return `user:${shortId(user_id)}`;
    }

    async function fetchNicknames(userIds){
      const ids = [...new Set((userIds || []).filter(Boolean))].filter(id => !state.nameByUserId.has(id));
      if(ids.length === 0) return;

      const { data, error } = await state.sb
        .from('profiles')
        .select('id, nickname')
        .in('id', ids);

      if(error){ console.error(error); return; }

      for(const row of (data ?? [])){
        state.nameByUserId.set(row.id, row.nickname || '');
      }
    }

    async function ensureMyProfile(){
      // profiles rowê°€ ì—†ìœ¼ë©´ ë§Œë“¤ì–´ë‘ê³ , ìˆìœ¼ë©´ ì½ì–´ì˜¤ê¸°
      const u = state.user;
      if(!u || !state.sb) return;

      // upsertë¡œ ê°•ì œ ìƒì„±(ë‹‰ë„¤ì„ì€ nullì´ì–´ë„ ë¨)
      await state.sb.from('profiles').upsert({ id: u.id }, { onConflict: 'id' });

      const { data } = await state.sb
        .from('profiles')
        .select('id, nickname')
        .eq('id', u.id)
        .maybeSingle();

      state.myProfile = data ?? { id: u.id, nickname: null };
      state.nameByUserId.set(u.id, state.myProfile.nickname || '');
    }

    async function loadMyStats(){
      const u = state.user;
      if(!u) return;

      const p = await state.sb
        .from('places')
        .select('id', { count: 'exact', head: true })
        .eq('user_id', u.id);

      const v = await state.sb
        .from('visits')
        .select('id', { count: 'exact', head: true })
        .eq('user_id', u.id);

      $('myPlacesCount').textContent = String(p.count ?? 0);
      $('myVisitsCount').textContent = String(v.count ?? 0);
    }

    function updateAuthUI(){
      const u = state.user;

      if(u){
        const nick = state.myProfile?.nickname ? state.myProfile.nickname : (u.email ?? 'ê³„ì •');
        $('authBtn').textContent = nick;

        $('loginCard').style.display = 'none';
        $('accountCard').style.display = 'block';
        $('authTitle').textContent = 'ê³„ì •';

        $('accountLine').textContent = u.email ?? '';
        $('nickname').value = state.myProfile?.nickname ?? '';

        $('editor').style.display = 'block';
        $('loginHint').style.display = 'none';
      } else {
        $('authBtn').textContent = 'ë¡œê·¸ì¸';

        $('loginCard').style.display = 'block';
        $('accountCard').style.display = 'none';
        $('authTitle').textContent = 'ë¡œê·¸ì¸ / íšŒì›ê°€ì…';

        $('editor').style.display = 'none';
        $('loginHint').style.display = 'block';
      }
    }

    function initMap(){
      if(!(window.kakao && window.kakao.maps)){
        toast('ì¹´ì¹´ì˜¤ ì§€ë„ SDK ë¡œë”© ì‹¤íŒ¨ (í‚¤/ë„ë©”ì¸/ì¹´ì¹´ì˜¤ë§µ ON í™•ì¸)');
        return;
      }
      const center = new kakao.maps.LatLng(37.5665, 126.9780);
      state.map = new kakao.maps.Map($('map'), { center, level: 6 });
      state.geocoder = new kakao.maps.services.Geocoder();
    }

    async function loadPlaces(){
      if(!state.sb) return;

      const { data, error } = await state.sb
        .from('places')
        .select('*')
        .order('created_at', { ascending: false });

      if(error){ console.error(error); toast('places ë¡œë”© ì‹¤íŒ¨'); return; }

      state.places = data ?? [];
      await fetchNicknames(state.places.map(p => p.user_id));
      renderMarkers();
    }

    function clearMarkers(){
      for(const m of state.markers.values()) m.setMap(null);
      state.markers.clear();
    }

    function renderMarkers(){
      if(!state.map) return;
      clearMarkers();

      for(const p of state.places){
        const marker = new kakao.maps.Marker({
          position: new kakao.maps.LatLng(p.lat, p.lng)
        });
        marker.setMap(state.map);
        kakao.maps.event.addListener(marker, 'click', ()=> openPlace(p.id));
        state.markers.set(p.id, marker);
      }
    }

    function closePanel(){
      close($('panel'));
      state.selectedPlace = null;
      $('placeName').textContent = 'ê°€ê²Œ ì„ íƒí•´ì¤˜';
      $('placeAddr').textContent = 'ë§ˆì»¤ ëˆ„ë¥´ë©´ ëœ¸';
      $('placeMeta').textContent = '';
      $('visits').innerHTML = '';
      $('panelHint').textContent = 'ë§ˆì»¤ í´ë¦­í•˜ë©´ ë°©ë¬¸ ê¸°ë¡ì´ ë³´ì—¬.';
    }

    async function openPlace(placeId){
      const place = state.places.find(p => p.id === placeId);
      if(!place) return;

      state.selectedPlace = place;
      await fetchNicknames([place.user_id]);

      $('placeName').textContent = place.name;
      $('placeAddr').textContent = place.address;

      const authorName = displayName(place.user_id);
      $('placeMeta').textContent = `ì¶”ê°€ì: ${authorName}`;

      $('panelHint').textContent = 'ë°©ë¬¸ê¸°ëŠ” ê³µê°œ. ë¡œê·¸ì¸í•˜ë©´ ì‘ì„± ê°€ëŠ¥.';
      $('visitDate').value = todayISO();
      $('visitRating').value = '';
      $('visitContent').value = '';

      open($('panel'));

      const pos = new kakao.maps.LatLng(place.lat, place.lng);
      state.map.setCenter(pos);
      state.map.setLevel(Math.min(state.map.getLevel(), 4));

      await loadVisitsAndRender(place.id);
    }

    async function loadVisitsAndRender(placeId){
      if(!state.sb) return;

      const wrap = $('visits');
      wrap.innerHTML = '<div class="hint">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';

      const { data, error } = await state.sb
        .from('visits')
        .select('*')
        .eq('place_id', placeId)
        .order('visited_at', { ascending: false })
        .order('created_at', { ascending: false });

      if(error){ console.error(error); toast('visits ë¡œë”© ì‹¤íŒ¨'); wrap.innerHTML=''; return; }

      const items = data ?? [];
      await fetchNicknames(items.map(v => v.user_id));

      if(items.length === 0){
        wrap.innerHTML = '<div class="hint">ì•„ì§ ë°©ë¬¸ ê¸°ë¡ ì—†ìŒ.</div>';
        return;
      }

      wrap.innerHTML = '';
      for(const v of items){
        const author = displayName(v.user_id, v.author_email);
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <div class="visitTop">
            <div style="font-weight:800">${esc(v.visited_at)}</div>
            <div class="badge">${v.rating == null ? 'í‰ì  ì—†ìŒ' : ('í‰ì  ' + esc(v.rating))}</div>
          </div>
          <div class="sub" style="margin-top:6px">ì‘ì„±ì: ${esc(author)}</div>
          <div class="visitContent">${esc(v.content || '')}</div>
        `;
        wrap.appendChild(div);
      }
    }

    function isSeoulByCoord(lat, lng){
      return new Promise((resolve) => {
        state.geocoder.coord2RegionCode(lng, lat, (res, status) => {
          if(status !== kakao.maps.services.Status.OK || !res || res.length === 0){
            resolve(true);
            return;
          }
          const any = res.find(x => x.region_1depth_name) || res[0];
          resolve((any.region_1depth_name || '').includes('ì„œìš¸'));
        });
      });
    }

    async function findDuplicatePlace(name, address){
      // ê°™ì€ name+addressê°€ ì´ë¯¸ ìˆìœ¼ë©´ ê·¸ row ë°˜í™˜
      const { data, error } = await state.sb
        .from('places')
        .select('id')
        .eq('name', name)
        .eq('address', address)
        .limit(1);

      if(error){ console.error(error); return null; }
      return (data && data.length > 0) ? data[0] : null;
    }

    async function createPlace({ name, address, lat, lng }){
      const u = state.user;
      if(!u){ toast('ê°€ê²Œ ì¶”ê°€ëŠ” ë¡œê·¸ì¸ í•„ìš”'); return null; }

      // 1) ì¤‘ë³µ í™•ì¸
      const dup = await findDuplicatePlace(name, address);
      if(dup){
        toast('ì´ë¯¸ ë“±ë¡ëœ ê°€ê²Œì•¼. ê·¸ìª½ìœ¼ë¡œ ì´ë™í• ê²Œ.');
        return { id: dup.id, existed: true };
      }

      // 2) insert (user_id ë°˜ë“œì‹œ í¬í•¨)
      const payload = { user_id: u.id, name, address, lat, lng };

      const { data, error } = await state.sb
        .from('places')
        .insert(payload)
        .select('*')
        .single();

      if(error){
        // ìœ ë‹ˆí¬ ì œì•½(places_name_address_unique) ìœ„ë°˜ë„ ì—¬ê¸°ë¡œ ë“¤ì–´ì˜´
        console.error(error);
        toast(error.message || 'ê°€ê²Œ ì €ì¥ ì‹¤íŒ¨');
        return null;
      }
      return { ...data, existed: false };
    }

    async function saveVisit(){
      const u = state.user;
      if(!u){ toast('ë¡œê·¸ì¸ í•„ìš”'); return; }
      if(!state.selectedPlace){ toast('ê°€ê²Œë¶€í„° ì„ íƒ'); return; }

      const visited_at = $('visitDate').value || todayISO();
      const ratingRaw = $('visitRating').value;
      const rating = (ratingRaw === '') ? null : Math.max(0, Math.min(5, Number(ratingRaw)));
      const content = ($('visitContent').value || '').trim();

      if(!content){ toast('ë°©ë¬¸ê¸° ë‚´ìš©ì„ ì¨ì¤˜'); return; }

      $('saveVisitBtn').disabled = true;
      try{
        const payload = {
          user_id: u.id,
          author_email: u.email || null,     // DBì— ë‚¨ê²¨ë‘ë˜, UIëŠ” ë‹‰ë„¤ì„ìœ¼ë¡œ ë³´ì—¬ì¤Œ
          place_id: state.selectedPlace.id,
          visited_at,
          rating,
          content
        };

        const { error } = await state.sb.from('visits').insert(payload);
        if(error){ console.error(error); toast(error.message || 'ì €ì¥ ì‹¤íŒ¨'); return; }

        $('visitContent').value = '';
        $('visitRating').value = '';
        toast('ì €ì¥ë¨');
        await loadVisitsAndRender(state.selectedPlace.id);
        await loadMyStats();
      } finally {
        $('saveVisitBtn').disabled = false;
      }
    }

    // ===== ì´ë²¤íŠ¸ ë°”ì¸ë”© =====
    window.addEventListener('DOMContentLoaded', () => {
      $('visitDate').value = todayISO();

      $('addBtn').addEventListener('click', () => {
        if(!state.user){
          toast('ì¶”ê°€ëŠ” ë¡œê·¸ì¸ í•„ìš”');
          open($('authOverlay'));
          return;
        }
        open($('addOverlay'));
      });
      $('closeAddBtn').addEventListener('click', ()=> close($('addOverlay')));

      $('authBtn').addEventListener('click', async ()=> {
        open($('authOverlay'));
        if(state.user){
          await loadMyStats();
        }
      });
      $('closeAuthBtn').addEventListener('click', ()=> close($('authOverlay')));

      $('closePanelBtn').addEventListener('click', closePanel);
      $('saveVisitBtn').addEventListener('click', saveVisit);

      $('loginBtn').addEventListener('click', async () => {
        const email = ($('email').value || '').trim();
        const password = $('password').value || '';
        if(!email || !password){ toast('ì´ë©”ì¼/ë¹„ë²ˆ ì…ë ¥'); return; }

        $('loginBtn').disabled = true;
        try{
          const { error } = await state.sb.auth.signInWithPassword({ email, password });
          if(error){ console.error(error); toast(error.message || 'ë¡œê·¸ì¸ ì‹¤íŒ¨'); return; }
          toast('ë¡œê·¸ì¸ ë¨');
          close($('authOverlay'));
          await ensureMyProfile();
          await loadMyStats();
        } finally {
          $('loginBtn').disabled = false;
        }
      });

      $('signupBtn').addEventListener('click', async () => {
        const email = ($('email').value || '').trim();
        const password = $('password').value || '';
        if(!email || !password){ toast('ì´ë©”ì¼/ë¹„ë²ˆ ì…ë ¥'); return; }

        $('signupBtn').disabled = true;
        try{
          const { error } = await state.sb.auth.signUp({ email, password });
          if(error){ console.error(error); toast(error.message || 'íšŒì›ê°€ì… ì‹¤íŒ¨'); return; }
          toast('íšŒì›ê°€ì… ì™„ë£Œ. ë°”ë¡œ ë¡œê·¸ì¸í•´ì¤˜.');
        } finally {
          $('signupBtn').disabled = false;
        }
      });

      $('logoutBtn').addEventListener('click', async () => {
        await state.sb.auth.signOut();
        toast('ë¡œê·¸ì•„ì›ƒ');
      });

      $('saveNickBtn').addEventListener('click', async () => {
        const u = state.user;
        if(!u){ toast('ë¡œê·¸ì¸ í•„ìš”'); return; }
        const nickname = ($('nickname').value || '').trim();
        if(!nickname){ toast('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì¤˜'); return; }

        $('saveNickBtn').disabled = true;
        try{
          const { error } = await state.sb
            .from('profiles')
            .upsert({ id: u.id, nickname }, { onConflict: 'id' });

          if(error){
            console.error(error);
            toast('ë‹‰ë„¤ì„ ì €ì¥ ì‹¤íŒ¨(ì¤‘ë³µì¼ ìˆ˜ ìˆìŒ)');
            return;
          }
          state.myProfile = { id: u.id, nickname };
          state.nameByUserId.set(u.id, nickname);
          updateAuthUI();

          // í™”ë©´ì— í‘œì‹œë˜ëŠ” â€œì¶”ê°€ì/ì‘ì„±ìâ€ë„ ë‹‰ë„¤ì„ìœ¼ë¡œ ë°”ë€Œê²Œ ê°±ì‹ 
          await loadPlaces();
          if(state.selectedPlace) await openPlace(state.selectedPlace.id);

          toast('ë‹‰ë„¤ì„ ì €ì¥ë¨');
        } finally {
          $('saveNickBtn').disabled = false;
        }
      });

      $('addrSearchBtn').addEventListener('click', () => {
        if(!state.geocoder){ toast('ì§€ë„ ì¤€ë¹„ ì•ˆ ë¨'); return; }

        const name = ($('newName').value || '').trim();
        const q = ($('newAddr').value || '').trim();
        if(!name){ toast('ê°€ê²Œ ì´ë¦„ë¶€í„°'); return; }
        if(!q){ toast('ì£¼ì†Œ(ê²€ìƒ‰ì–´)ë¶€í„°'); return; }

        $('geoStatus').textContent = 'ì°¾ëŠ” ì¤‘â€¦';
        $('results').innerHTML = '';

        state.geocoder.addressSearch(q, (result, status) => {
          if(status !== kakao.maps.services.Status.OK || !result || result.length === 0){
            $('geoStatus').textContent = 'ê²°ê³¼ ì—†ìŒ';
            return;
          }

          $('geoStatus').textContent = `í›„ë³´ ${result.length}ê°œ`;

          for(const r of result){
            const lat = Number(r.y);
            const lng = Number(r.x);
            const addr = (r.address_name || q).trim();

            const item = document.createElement('div');
            item.className = 'resultItem';
            item.innerHTML = `
              <div class="t">${esc(name)}</div>
              <div class="s">${esc(addr)}</div>
              <div class="s">ì¢Œí‘œ: ${lat.toFixed(5)}, ${lng.toFixed(5)}</div>
            `;

            item.addEventListener('click', async () => {
              const ok = await isSeoulByCoord(lat, lng);
              if(!ok){ toast('ì„œìš¸ì´ ì•„ë‹ˆë©´ ì €ì¥ ì•ˆ í•¨'); return; }

              const created = await createPlace({ name, address: addr, lat, lng });
              if(!created) return;

              close($('addOverlay'));
              $('newName').value = '';
              $('newAddr').value = '';
              $('results').innerHTML = '';
              $('geoStatus').textContent = '';

              await loadPlaces();

              if(created.existed){
                await openPlace(created.id);
              } else {
                toast('ê°€ê²Œ ì¶”ê°€ë¨');
                await openPlace(created.id);
                await loadMyStats();
              }
            });

            $('results').appendChild(item);
          }
        });
      });

      $('q').addEventListener('keydown', (e) => {
        if(e.key !== 'Enter') return;
        const q = ($('q').value || '').trim().toLowerCase();
        if(!q) return;

        const hit = state.places.find(p =>
          (p.name || '').toLowerCase().includes(q) ||
          (p.address || '').toLowerCase().includes(q)
        );

        if(!hit){ toast('ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ'); return; }
        openPlace(hit.id);
      });
    });

    // ===== ë¶€íŒ… =====
    window.addEventListener('load', async () => {
      initMap();
      await initSupabase();
      await loadPlaces();
      if(state.user) await loadMyStats();
    });
  </script>
</body>
</html>
